

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Implementation of CoFi for marine traffic modeling &mdash; ProMis 2.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=51b770b3"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            ProMis
              <img src="../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gui.html">Graphical User Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ProMis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Implementation of CoFi for marine traffic modeling</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notebooks/cofi-maritime.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Implementation-of-CoFi-for-marine-traffic-modeling">
<h1>Implementation of CoFi for marine traffic modeling<a class="headerlink" href="#Implementation-of-CoFi-for-marine-traffic-modeling" title="Link to this heading"></a></h1>
<p>This notebook showcases how to use Consititional Filters (CoFi) in ProMis to improve modeling of ship movements.</p>
<section id="Setup">
<h2>Setup<a class="headerlink" href="#Setup" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This will auto-relead changed ProMis imports</span>
<span class="o">%</span><span class="k">reload_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We need some additional packages</span>
<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>-q<span class="w"> </span>svgpath2mpl<span class="w"> </span>svgpathtools<span class="w"> </span>filterpy<span class="w"> </span>keplergl
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-yellow-fg">WARNING: Running pip as the &#39;root&#39; user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv</span><span class="ansi-yellow-fg">
</span>
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Standard library</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">ceil</span><span class="p">,</span> <span class="n">isfinite</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">monotonic</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>

<span class="c1"># Math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">array</span><span class="p">,</span> <span class="n">deg2rad</span><span class="p">,</span> <span class="n">eye</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">set_printoptions</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">rad2deg</span><span class="p">,</span> <span class="n">deg2rad</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy.random</span><span class="w"> </span><span class="kn">import</span> <span class="n">seed</span><span class="p">,</span> <span class="n">standard_normal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span><span class="p">,</span> <span class="n">uniform</span>

<span class="c1"># Data Handling</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">filterpy.monte_carlo</span><span class="w"> </span><span class="kn">import</span> <span class="n">systematic_resample</span><span class="p">,</span> <span class="n">stratified_resample</span>

<span class="c1"># Other Third Party</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rich.progress</span><span class="w"> </span><span class="kn">import</span> <span class="n">track</span>

<span class="c1"># Plotting</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">keplergl</span><span class="w"> </span><span class="kn">import</span> <span class="n">KeplerGl</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.animation</span><span class="w"> </span><span class="kn">import</span> <span class="n">FuncAnimation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.transforms</span><span class="w"> </span><span class="kn">import</span> <span class="n">Affine2D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="kn">import</span> <span class="n">move_legend</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">svgpath2mpl</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse_path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">svgpathtools</span><span class="w"> </span><span class="kn">import</span> <span class="n">svg2paths</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="c1"># ProMis</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">promis</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProMis</span><span class="p">,</span> <span class="n">StaRMap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">promis.geo</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">CartesianCollection</span><span class="p">,</span>
    <span class="n">CartesianMap</span><span class="p">,</span>
    <span class="n">CartesianRasterBand</span><span class="p">,</span>
    <span class="n">PolarCollection</span><span class="p">,</span>
    <span class="n">PolarLocation</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">promis.loaders</span><span class="w"> </span><span class="kn">import</span> <span class="n">NauticalChartLoader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">promis.logic.spatial</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depth</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use full width of juptyer notebook</span>
<span class="n">set_printoptions</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span> <span class="n">formatter</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;float_kind&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:4.6f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">})</span>

<span class="c1"># Make plots look nice in a paper</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;pdf.fonttype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;ps.fonttype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span>

<span class="n">sns</span><span class="o">.</span><span class="n">set_theme</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;ticks&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="s2">&quot;legend.title_fontsize&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">({</span><span class="s2">&quot;font.family&quot;</span><span class="p">:</span> <span class="s2">&quot;serif&quot;</span><span class="p">,</span> <span class="s2">&quot;font.serif&quot;</span><span class="p">:</span> <span class="s2">&quot;Times New Roman&quot;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</section>
<section id="Define-the-setting">
<h2>Define the setting<a class="headerlink" href="#Define-the-setting" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The format of the bbox is:</span>
<span class="c1"># (lat, lon) lower left, and then</span>
<span class="c1"># (lat, lon) upper right</span>

<span class="n">setting</span> <span class="o">=</span> <span class="s2">&quot;New York Harbor&quot;</span>
<span class="n">bbox</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="mf">40.52</span><span class="p">,</span> <span class="o">-</span><span class="mf">74.08</span><span class="p">),</span>
    <span class="p">(</span><span class="mf">40.70</span><span class="p">,</span> <span class="o">-</span><span class="mf">73.85</span><span class="p">),</span>
<span class="p">)</span>

<span class="c1"># setting = &quot;Port of Charleston, South Carolina&quot;</span>
<span class="c1"># bbox = (</span>
<span class="c1">#     (32.75, -79.97),</span>
<span class="c1">#     (32.875, -79.87),</span>
<span class="c1"># )</span>

<span class="c1"># setting = &quot;Baltimore&quot;</span>
<span class="c1"># bbox = (</span>
<span class="c1">#     (39.174, -76.6304993),</span>
<span class="c1">#     (39.29, -76.4495423),</span>
<span class="c1"># )</span>

<span class="c1"># setting = &quot;Port of Virginia (Norfolk)&quot;</span>
<span class="c1"># bbox = (</span>
<span class="c1">#     (36.7711453, -76.4994133),</span>
<span class="c1">#     (37.3020172, -75.8786833),</span>
<span class="c1"># )</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;cofi-exports&quot;</span> <span class="o">/</span> <span class="n">setting</span>
<span class="n">output_folder</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">origin</span> <span class="o">=</span> <span class="n">PolarLocation</span><span class="p">(</span>
    <span class="n">latitude</span><span class="o">=</span><span class="n">mean</span><span class="p">([</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]),</span> <span class="n">longitude</span><span class="o">=</span><span class="n">mean</span><span class="p">([</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
<span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="n">PolarLocation</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">longitude</span><span class="o">=</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span>
    <span class="n">PolarLocation</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">longitude</span><span class="o">=</span><span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
<span class="p">)</span>
<span class="n">height</span> <span class="o">=</span> <span class="n">PolarLocation</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">longitude</span><span class="o">=</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span>
    <span class="n">PolarLocation</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">longitude</span><span class="o">=</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
<span class="p">)</span>
<span class="n">dimensions</span> <span class="o">=</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span>
<span class="n">dimensions</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(19490.788929051603, 19988.34793513066)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">target_resolution</span> <span class="o">=</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">support_resolution</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Load-the-nautical-chart-data">
<h2>Load the nautical chart data<a class="headerlink" href="#Load-the-nautical-chart-data" title="Link to this heading"></a></h2>
<p>Like all somewhat time-consuming steps, this only needs to be done once.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">uam_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;nautical_chart_uam.pkl&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">uam_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="n">uam</span> <span class="o">=</span> <span class="n">CartesianMap</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">uam_path</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">NauticalChartLoader</span><span class="p">(</span>
        <span class="n">chart_root</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="s2">&quot;us_charts-ny&quot;</span><span class="p">,</span>
        <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
        <span class="n">dimensions</span><span class="o">=</span><span class="n">dimensions</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">loader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

    <span class="n">uam</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">to_cartesian_map</span><span class="p">()</span>
    <span class="n">uam</span><span class="o">.</span><span class="n">apply_covariance</span><span class="p">(</span><span class="mf">50.0</span> <span class="o">*</span> <span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">uam</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">uam_path</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">uam</span><span class="o">.</span><span class="n">features</span><span class="p">)</span><span class="si">}</span><span class="s2"> features&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Loaded 3802 features
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print the some features</span>
<span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">uam</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">500</span><span class="p">:</span><span class="mi">1000</span><span class="p">:</span><span class="mi">31</span><span class="p">]:</span>  <span class="c1"># Get some diversity</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">feature</span><span class="o">.</span><span class="n">location_type</span><span class="si">}</span><span class="s2">: </span><span class="se">\t</span><span class="si">{</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CartesianPolygon - anchorage:   US5NYCCF#0226118FBFB01C82 (Anchor berth (single)): &#34;G3&#34;
CartesianPolygon - anchorage:   US5NYCCF#022602C159BB1C82 (Anchor berth (single)): &#34;O5&#34;
CartesianPolygon - anchorage:   US5NYCCF#022622152D461C82 (Anchor berth (single)): &#34;K10&#34;
CartesianPolygon - anchorage:   US5NYCCF#022608F3C61E1C82 (Anchor berth (single)): &#34;N6&#34;
CartesianPolygon - anchorage:   US5NYCCF#0226242A0CDD1C82 (Anchor berth (single)): &#34;I6&#34;
CartesianPolygon - anchorage:   US5NYCCF#02260B6F82FB1C82 (Anchor berth (single)): &#34;N8&#34;
CartesianPolygon - anchorage:   US5NYCCF#022639479B711C82 (Anchor berth (single)): &#34;E5&#34;
CartesianPolygon - anchorage:   US5NYCCF#02263ABB47F41C82 (Anchor berth (single)): &#34;M5&#34;
CartesianPolygon - anchorage:   US5NYCCF#02261DC124E61C82 (Anchor berth (single)): &#34;F4&#34;
CartesianPolygon - anchorage:   US5NYCCF#02262DB2D5AE1C82 (Anchor berth (single)): &#34;C9&#34;
CartesianPolygon - anchorage:   US5NYCCF#022605EDE0241C82 (Anchor berth (single)): &#34;P2&#34;
CartesianPolygon - anchorage:   US5NYCCF#02263A96014D1C82 (Anchor berth (single)): &#34;T3&#34;
CartesianPolygon - anchorage:   US5NYCCF#0226002428481C82 (Anchor berth (single)): &#34;C5&#34;
CartesianLocation - obstruction:        US5NYCCF#02260220C0F30032 (Buoy (BOYLAT)): &#34;Craven Shoal Lighted Gong Buoy 23&#34;
CartesianPolygon - water:       US5NYCCF#022633543B081940 (Depth=4.0m): &#34;---&#34;
CartesianPolygon - water:       US5NYCCF#02261248779F1C82 (Depth=5.0m): &#34;---&#34;
CartesianPolygon - water:       US5NYCCF#0226391006241C82 (Depth=5.0m): &#34;---&#34;
</pre></div></div>
</div>
</section>
<section id="Prepare-the-mission-landscape">
<h2>Prepare the mission landscape<a class="headerlink" href="#Prepare-the-mission-landscape" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">logic_specifics_dummy</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">% Perception from sensors</span>
<span class="s2">draught ~ normal(3, 0.5).</span>
<span class="s2">0.1::anchoring.</span>
<span class="s2">0.9::travels_waterways.</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">logic</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">% Background knowledge</span>
<span class="s2">sufficient_depth(X) :-</span>
<span class="s2">    A is depth(X, water), B is draught,</span>
<span class="s2">    A + B &lt; -1.5, \+ over(X, land).</span>

<span class="s2">0.95::safe(X) :-</span>
<span class="s2">    sufficient_depth(X), distance(X, land) &gt; 50.</span>

<span class="s2">proper_anchorage(X) :-</span>
<span class="s2">    anchoring, over(X, anchorage);</span>
<span class="s2">    \+ anchoring, \+ over(X, anchorage).</span>

<span class="s2">0.90::waterway_preference(X) :-</span>
<span class="s2">    travels_waterways, distance(X, waterway) &lt; 400;</span>
<span class="s2">    \+ travels_waterways.</span>

<span class="s2">% Compliance with Constitution</span>
<span class="s2">landscape(X) :-</span>
<span class="s2">    proper_anchorage(X), safe(X),</span>
<span class="s2">    waterway_preference(X).</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">support</span> <span class="o">=</span> <span class="n">CartesianRasterBand</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">support_resolution</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">CartesianRasterBand</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">target_resolution</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">starmap_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;maritime_star_map.pkl&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">starmap_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="n">star_map</span> <span class="o">=</span> <span class="n">StaRMap</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">starmap_path</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="c1"># We create a statistical relational map (StaR Map) to represent the</span>
    <span class="c1"># stochastic relationships in the environment, computing a raster of 100 x 100 points</span>
    <span class="c1"># using linear interpolation of a sample set</span>
    <span class="n">before</span> <span class="o">=</span> <span class="n">monotonic</span><span class="p">()</span>
    <span class="n">star_map</span> <span class="o">=</span> <span class="n">StaRMap</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">uam</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>

    <span class="n">star_map</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span>
        <span class="c1"># The sample points for which the relations will be computed directly</span>
        <span class="n">support</span><span class="o">=</span><span class="n">support</span><span class="p">,</span>
        <span class="c1"># We now compute the Distance and Over relationships for the selected points</span>
        <span class="c1"># For this, we take many random samples from generated/possible map variations</span>
        <span class="n">number_of_random_maps</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  <span class="c1"># TODO</span>
        <span class="c1"># The logic used later. This is required to determine which relationships to prepare</span>
        <span class="n">logic</span><span class="o">=</span><span class="n">logic</span> <span class="o">+</span> <span class="n">logic_specifics_dummy</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">after</span> <span class="o">=</span> <span class="n">monotonic</span><span class="p">()</span>

    <span class="n">star_map</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">starmap_path</span><span class="p">)</span>

    <span class="n">runtime</span> <span class="o">=</span> <span class="n">after</span> <span class="o">-</span> <span class="n">before</span>
    <span class="sa">f</span><span class="s2">&quot;Computed StaR Map in </span><span class="si">{</span><span class="n">runtime</span><span class="si">}</span><span class="s2"> seconds&quot;</span>
<br/></pre></div>
</div>
</div>
<section id="Visualize-the-relations">
<h3>Visualize the relations<a class="headerlink" href="#Visualize-the-relations" title="Link to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We first plot the depth since we have some special handling for it</span>
<span class="n">depth</span><span class="p">:</span> <span class="n">Depth</span> <span class="o">=</span> <span class="n">star_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="s2">&quot;water&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Depth (mean)&quot;</span><span class="p">)</span>
<span class="n">depth</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">value_index</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_18_0.png" src="../_images/notebooks_cofi-maritime_18_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Figure size 1000x400 with 0 Axes&gt;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Depth (variance)&quot;</span><span class="p">)</span>
<span class="n">depth</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">value_index</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_19_0.png" src="../_images/notebooks_cofi-maritime_19_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Figure size 1000x400 with 0 Axes&gt;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_relations</span> <span class="o">=</span> <span class="n">star_map</span><span class="o">.</span><span class="n">relation_and_location_types</span>
<span class="n">all_relations</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;over&#39;: {&#39;anchorage&#39;, &#39;land&#39;},
 &#39;distance&#39;: {&#39;land&#39;, &#39;waterway&#39;},
 &#39;depth&#39;: {&#39;water&#39;}}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create one row per relation type and one column per location type</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">all_relations</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">star_map</span><span class="o">.</span><span class="n">location_types</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">relation_type</span><span class="p">,</span> <span class="n">location_types</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_relations</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">location_type</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">star_map</span><span class="o">.</span><span class="n">location_types</span><span class="p">):</span>
        <span class="c1"># Get the axis for the current row and column</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

        <span class="c1"># Label the rows and columns</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">relation_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">location_type</span><span class="p">)</span>

        <span class="c1"># Get the relation and visualize it</span>
        <span class="k">if</span> <span class="n">location_type</span> <span class="ow">in</span> <span class="n">location_types</span><span class="p">:</span>
            <span class="n">relation</span> <span class="o">=</span> <span class="n">star_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">relation_type</span><span class="p">,</span> <span class="n">location_type</span><span class="p">)</span>
            <span class="n">relation</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">value_index</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No data available, but we still want to show the label</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
            <span class="c1"># Despine</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># if j == len(all_location_types) - 1:</span>
        <span class="c1">#     plt.colorbar()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Lowered zoom level to keep map size reasonable. (z = 12)
Lowered zoom level to keep map size reasonable. (z = 12)
Lowered zoom level to keep map size reasonable. (z = 12)
Lowered zoom level to keep map size reasonable. (z = 12)
Lowered zoom level to keep map size reasonable. (z = 12)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_21_1.png" src="../_images/notebooks_cofi-maritime_21_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Figure size 1000x400 with 0 Axes&gt;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">relation</span> <span class="o">=</span> <span class="n">star_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;over&quot;</span><span class="p">,</span> <span class="s2">&quot;land&quot;</span><span class="p">)</span>
<span class="n">relation</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Lowered zoom level to keep map size reasonable. (z = 12)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_22_1.png" src="../_images/notebooks_cofi-maritime_22_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Figure size 1000x400 with 0 Axes&gt;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">folder</span> <span class="o">=</span> <span class="n">output_folder</span> <span class="o">/</span> <span class="s2">&quot;relations&quot;</span>
<span class="n">folder</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">relation_type</span><span class="p">,</span> <span class="n">location_types</span> <span class="ow">in</span> <span class="n">star_map</span><span class="o">.</span><span class="n">relation_and_location_types</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">location_type</span> <span class="ow">in</span> <span class="n">location_types</span><span class="p">:</span>
        <span class="n">relation</span> <span class="o">=</span> <span class="n">star_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">relation_type</span><span class="p">,</span> <span class="n">location_type</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">relation_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">location_type</span><span class="si">}</span><span class="s2">.csv&quot;</span>
        <span class="n">relation</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">to_polar</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Run-some-inference">
<h3>Run some inference<a class="headerlink" href="#Run-some-inference" title="Link to this heading"></a></h3>
<p>To make sure everything will run smoothly, we can run some inference on the data.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># In ProMis, we define the constraints of the mission</span>
<span class="c1"># as hybrid probabilistic first-order logic programs</span>

<span class="c1"># Solve mission constraints using StaRMap parameters and multiprocessing</span>
<span class="n">promis</span> <span class="o">=</span> <span class="n">ProMis</span><span class="p">(</span><span class="n">star_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solve an example logic program</span>
<span class="n">landscape</span> <span class="o">=</span> <span class="n">promis</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span>
    <span class="n">support</span><span class="p">,</span> <span class="n">logic</span> <span class="o">+</span> <span class="n">logic_specifics_dummy</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">print_first</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># Show the resulting landscape</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">landscape</span><span class="o">.</span><span class="n">scatter</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Probability&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

% Background knowledge
sufficient_depth(X) :-
    A is depth(X, water), B is draught,
    A + B &lt; -1.5, \+ over(X, land).

0.95::safe(X) :-
    sufficient_depth(X), distance(X, land) &gt; 50.

proper_anchorage(X) :-
    anchoring, over(X, anchorage);
    \+ anchoring, \+ over(X, anchorage).

0.90::waterway_preference(X) :-
    travels_waterways, distance(X, waterway) &lt; 400;
    \+ travels_waterways.

% Compliance with Constitution
landscape(X) :-
    proper_anchorage(X), safe(X),
    waterway_preference(X).

% Perception from sensors
draught ~ normal(3, 0.5).
0.1::anchoring.
0.9::travels_waterways.

depth(x_0, water) ~ normal(-6.0, 0.001).
distance(x_0, waterway) ~ normal(3062.361577277537, 0.001).
distance(x_0, land) ~ normal(3731.38903012275, 0.001).
0.0::over(x_0, anchorage).
0.0::over(x_0, land).
query(landscape(x_0)).
depth(x_1, water) ~ normal(-6.0, 0.001).
distance(x_1, waterway) ~ normal(2865.4850686239174, 0.001).
distance(x_1, land) ~ normal(3566.6827659221826, 0.001).
0.0::over(x_1, anchorage).
0.0::over(x_1, land).
query(landscape(x_1)).
depth(x_2, water) ~ normal(-6.0, 0.001).
distance(x_2, waterway) ~ normal(2668.6085816889754, 0.001).
distance(x_2, land) ~ normal(3405.39405158475, 0.001).
0.0::over(x_2, anchorage).
0.0::over(x_2, land).
query(landscape(x_2)).

Lowered zoom level to keep map size reasonable. (z = 12)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_26_1.png" src="../_images/notebooks_cofi-maritime_26_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Figure size 1000x400 with 0 Axes&gt;
</pre></div></div>
</div>
</section>
</section>
<section id="Load-some-AIS-data">
<h2>Load some AIS data<a class="headerlink" href="#Load-some-AIS-data" title="Link to this heading"></a></h2>
<p>The Automatic Identification System (AIS) is a system used for tracking ships. We will use its observations as our measurements and for model validation.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vessel_types</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">((</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;vessel_types_simplified.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">load_ais</span><span class="p">(</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="n">bbox</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="c1"># Read the csv into pandas</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># Filter by bounding box</span>
    <span class="k">if</span> <span class="n">bbox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># This is a overly simplistic bounding box filter that only works on moderate latitudes</span>
        <span class="c1"># and far from the dateline</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;LON&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;LON&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">]</span>

    <span class="c1"># Sort by time per ship</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;BaseDateTime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;BaseDateTime&quot;</span><span class="p">])</span>
    <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;MMSI&quot;</span><span class="p">,</span> <span class="s2">&quot;BaseDateTime&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;VesselType&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span> <span class="s2">&quot;VesselType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Zero means unknown</span>

    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;VesselType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;VesselType&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;VesselTypeName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;VesselType&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">vessel_types</span><span class="p">)</span>

    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;is_anchoring&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="c1"># Filter out all vessels that have an average SOG of less than 1 knot</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;MMSI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;SOG&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>


<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">load_ais</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="s2">&quot;ais&quot;</span> <span class="o">/</span> <span class="s2">&quot;AIS_2023_08_01.csv&quot;</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">bbox</span><span class="p">),</span>
        <span class="n">load_ais</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="s2">&quot;ais&quot;</span> <span class="o">/</span> <span class="s2">&quot;AIS_2023_08_02.csv&quot;</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">bbox</span><span class="p">),</span>
        <span class="n">load_ais</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="s2">&quot;ais&quot;</span> <span class="o">/</span> <span class="s2">&quot;AIS_2023_08_03.csv&quot;</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">bbox</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>MMSI</th>
      <th>BaseDateTime</th>
      <th>LAT</th>
      <th>LON</th>
      <th>SOG</th>
      <th>COG</th>
      <th>Heading</th>
      <th>VesselName</th>
      <th>IMO</th>
      <th>CallSign</th>
      <th>VesselType</th>
      <th>Status</th>
      <th>Length</th>
      <th>Width</th>
      <th>Draft</th>
      <th>Cargo</th>
      <th>TransceiverClass</th>
      <th>VesselTypeName</th>
      <th>is_anchoring</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>9007215</th>
      <td>232040168</td>
      <td>2023-08-01 19:06:21</td>
      <td>40.52027</td>
      <td>-74.03197</td>
      <td>8.7</td>
      <td>339.7</td>
      <td>344.0</td>
      <td>DANCING BEAR</td>
      <td>IMO0000000</td>
      <td>MKTD4</td>
      <td>37</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>B</td>
      <td>Pleasure craft</td>
      <td>False</td>
    </tr>
    <tr>
      <th>6671099</th>
      <td>232040168</td>
      <td>2023-08-01 19:07:49</td>
      <td>40.52332</td>
      <td>-74.03350</td>
      <td>7.9</td>
      <td>336.6</td>
      <td>345.0</td>
      <td>DANCING BEAR</td>
      <td>IMO0000000</td>
      <td>MKTD4</td>
      <td>37</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>B</td>
      <td>Pleasure craft</td>
      <td>False</td>
    </tr>
    <tr>
      <th>9009252</th>
      <td>232040168</td>
      <td>2023-08-01 19:09:19</td>
      <td>40.52637</td>
      <td>-74.03515</td>
      <td>7.9</td>
      <td>340.2</td>
      <td>349.0</td>
      <td>DANCING BEAR</td>
      <td>IMO0000000</td>
      <td>MKTD4</td>
      <td>37</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>B</td>
      <td>Pleasure craft</td>
      <td>False</td>
    </tr>
    <tr>
      <th>6685546</th>
      <td>232040168</td>
      <td>2023-08-01 19:10:21</td>
      <td>40.52848</td>
      <td>-74.03587</td>
      <td>8.7</td>
      <td>353.3</td>
      <td>356.0</td>
      <td>DANCING BEAR</td>
      <td>IMO0000000</td>
      <td>MKTD4</td>
      <td>37</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>B</td>
      <td>Pleasure craft</td>
      <td>False</td>
    </tr>
    <tr>
      <th>6697396</th>
      <td>232040168</td>
      <td>2023-08-01 19:12:25</td>
      <td>40.53272</td>
      <td>-74.03660</td>
      <td>5.5</td>
      <td>344.6</td>
      <td>357.0</td>
      <td>DANCING BEAR</td>
      <td>IMO0000000</td>
      <td>MKTD4</td>
      <td>37</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>B</td>
      <td>Pleasure craft</td>
      <td>False</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1461703</th>
      <td>636093148</td>
      <td>2023-08-03 04:20:36</td>
      <td>40.53343</td>
      <td>-74.01964</td>
      <td>18.5</td>
      <td>143.2</td>
      <td>143.0</td>
      <td>TANGIER EXPRESS</td>
      <td>IMO9525900</td>
      <td>5LDS8</td>
      <td>74</td>
      <td>0.0</td>
      <td>366.0</td>
      <td>48.0</td>
      <td>11.5</td>
      <td>74.0</td>
      <td>A</td>
      <td>Cargo, hazardous</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1469270</th>
      <td>636093148</td>
      <td>2023-08-03 04:21:38</td>
      <td>40.52939</td>
      <td>-74.01512</td>
      <td>18.6</td>
      <td>136.1</td>
      <td>136.0</td>
      <td>TANGIER EXPRESS</td>
      <td>IMO9525900</td>
      <td>5LDS8</td>
      <td>74</td>
      <td>0.0</td>
      <td>366.0</td>
      <td>48.0</td>
      <td>11.5</td>
      <td>74.0</td>
      <td>A</td>
      <td>Cargo, hazardous</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1466812</th>
      <td>636093148</td>
      <td>2023-08-03 04:22:40</td>
      <td>40.52575</td>
      <td>-74.00995</td>
      <td>18.8</td>
      <td>127.2</td>
      <td>128.0</td>
      <td>TANGIER EXPRESS</td>
      <td>IMO9525900</td>
      <td>5LDS8</td>
      <td>74</td>
      <td>0.0</td>
      <td>366.0</td>
      <td>48.0</td>
      <td>11.5</td>
      <td>74.0</td>
      <td>A</td>
      <td>Cargo, hazardous</td>
      <td>False</td>
    </tr>
    <tr>
      <th>6082811</th>
      <td>636093148</td>
      <td>2023-08-03 04:23:44</td>
      <td>40.52275</td>
      <td>-74.00377</td>
      <td>18.9</td>
      <td>118.3</td>
      <td>118.0</td>
      <td>TANGIER EXPRESS</td>
      <td>IMO9525900</td>
      <td>5LDS8</td>
      <td>74</td>
      <td>0.0</td>
      <td>366.0</td>
      <td>48.0</td>
      <td>11.5</td>
      <td>74.0</td>
      <td>A</td>
      <td>Cargo, hazardous</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1487102</th>
      <td>636093148</td>
      <td>2023-08-03 04:24:50</td>
      <td>40.52001</td>
      <td>-73.99690</td>
      <td>19.3</td>
      <td>117.0</td>
      <td>118.0</td>
      <td>TANGIER EXPRESS</td>
      <td>IMO9525900</td>
      <td>5LDS8</td>
      <td>74</td>
      <td>0.0</td>
      <td>366.0</td>
      <td>48.0</td>
      <td>11.5</td>
      <td>74.0</td>
      <td>A</td>
      <td>Cargo, hazardous</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
<p>131194 rows × 19 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Draft&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_30_0.png" src="../_images/notebooks_cofi-maritime_30_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Length&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_31_0.png" src="../_images/notebooks_cofi-maritime_31_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Status&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Status
0.0     94525
1.0      3547
2.0       353
3.0         7
5.0     11087
6.0       907
7.0        97
8.0       416
9.0       338
11.0      123
12.0     7142
15.0     6560
Name: count, dtype: int64
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Status&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">()</span>
<span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_33_0.png" src="../_images/notebooks_cofi-maritime_33_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">collection</span> <span class="o">=</span> <span class="n">PolarCollection</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">number_of_values</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">collection</span><span class="o">.</span><span class="n">append_with_default</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;LON&quot;</span><span class="p">,</span> <span class="s2">&quot;LAT&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="p">())</span>
<span class="n">cartesian</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">to_cartesian</span><span class="p">()</span>

<span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;East&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cartesian</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;east&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;North&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cartesian</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;north&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>MMSI</th>
      <th>BaseDateTime</th>
      <th>LAT</th>
      <th>LON</th>
      <th>SOG</th>
      <th>COG</th>
      <th>Heading</th>
      <th>VesselName</th>
      <th>IMO</th>
      <th>CallSign</th>
      <th>...</th>
      <th>Status</th>
      <th>Length</th>
      <th>Width</th>
      <th>Draft</th>
      <th>Cargo</th>
      <th>TransceiverClass</th>
      <th>VesselTypeName</th>
      <th>is_anchoring</th>
      <th>East</th>
      <th>North</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>9007215</th>
      <td>232040168</td>
      <td>2023-08-01 19:06:21</td>
      <td>40.52027</td>
      <td>-74.03197</td>
      <td>8.7</td>
      <td>339.7</td>
      <td>344.0</td>
      <td>DANCING BEAR</td>
      <td>IMO0000000</td>
      <td>MKTD4</td>
      <td>...</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>B</td>
      <td>Pleasure craft</td>
      <td>False</td>
      <td>-5675.188325</td>
      <td>-9961.958870</td>
    </tr>
    <tr>
      <th>6671099</th>
      <td>232040168</td>
      <td>2023-08-01 19:07:49</td>
      <td>40.52332</td>
      <td>-74.03350</td>
      <td>7.9</td>
      <td>336.6</td>
      <td>345.0</td>
      <td>DANCING BEAR</td>
      <td>IMO0000000</td>
      <td>MKTD4</td>
      <td>...</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>B</td>
      <td>Pleasure craft</td>
      <td>False</td>
      <td>-5804.580884</td>
      <td>-9623.172981</td>
    </tr>
    <tr>
      <th>9009252</th>
      <td>232040168</td>
      <td>2023-08-01 19:09:19</td>
      <td>40.52637</td>
      <td>-74.03515</td>
      <td>7.9</td>
      <td>340.2</td>
      <td>349.0</td>
      <td>DANCING BEAR</td>
      <td>IMO0000000</td>
      <td>MKTD4</td>
      <td>...</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>B</td>
      <td>Pleasure craft</td>
      <td>False</td>
      <td>-5944.129822</td>
      <td>-9284.376577</td>
    </tr>
    <tr>
      <th>6685546</th>
      <td>232040168</td>
      <td>2023-08-01 19:10:21</td>
      <td>40.52848</td>
      <td>-74.03587</td>
      <td>8.7</td>
      <td>353.3</td>
      <td>356.0</td>
      <td>DANCING BEAR</td>
      <td>IMO0000000</td>
      <td>MKTD4</td>
      <td>...</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>B</td>
      <td>Pleasure craft</td>
      <td>False</td>
      <td>-6004.950390</td>
      <td>-9050.023266</td>
    </tr>
    <tr>
      <th>6697396</th>
      <td>232040168</td>
      <td>2023-08-01 19:12:25</td>
      <td>40.53272</td>
      <td>-74.03660</td>
      <td>5.5</td>
      <td>344.6</td>
      <td>357.0</td>
      <td>DANCING BEAR</td>
      <td>IMO0000000</td>
      <td>MKTD4</td>
      <td>...</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>B</td>
      <td>Pleasure craft</td>
      <td>False</td>
      <td>-6066.422330</td>
      <td>-8579.143087</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1461703</th>
      <td>636093148</td>
      <td>2023-08-03 04:20:36</td>
      <td>40.53343</td>
      <td>-74.01964</td>
      <td>18.5</td>
      <td>143.2</td>
      <td>143.0</td>
      <td>TANGIER EXPRESS</td>
      <td>IMO9525900</td>
      <td>5LDS8</td>
      <td>...</td>
      <td>0.0</td>
      <td>366.0</td>
      <td>48.0</td>
      <td>11.5</td>
      <td>74.0</td>
      <td>A</td>
      <td>Cargo, hazardous</td>
      <td>False</td>
      <td>-4629.410780</td>
      <td>-8501.329992</td>
    </tr>
    <tr>
      <th>1469270</th>
      <td>636093148</td>
      <td>2023-08-03 04:21:38</td>
      <td>40.52939</td>
      <td>-74.01512</td>
      <td>18.6</td>
      <td>136.1</td>
      <td>136.0</td>
      <td>TANGIER EXPRESS</td>
      <td>IMO9525900</td>
      <td>5LDS8</td>
      <td>...</td>
      <td>0.0</td>
      <td>366.0</td>
      <td>48.0</td>
      <td>11.5</td>
      <td>74.0</td>
      <td>A</td>
      <td>Cargo, hazardous</td>
      <td>False</td>
      <td>-4246.705751</td>
      <td>-8950.178790</td>
    </tr>
    <tr>
      <th>1466812</th>
      <td>636093148</td>
      <td>2023-08-03 04:22:40</td>
      <td>40.52575</td>
      <td>-74.00995</td>
      <td>18.8</td>
      <td>127.2</td>
      <td>128.0</td>
      <td>TANGIER EXPRESS</td>
      <td>IMO9525900</td>
      <td>5LDS8</td>
      <td>...</td>
      <td>0.0</td>
      <td>366.0</td>
      <td>48.0</td>
      <td>11.5</td>
      <td>74.0</td>
      <td>A</td>
      <td>Cargo, hazardous</td>
      <td>False</td>
      <td>-3808.853762</td>
      <td>-9354.618008</td>
    </tr>
    <tr>
      <th>6082811</th>
      <td>636093148</td>
      <td>2023-08-03 04:23:44</td>
      <td>40.52275</td>
      <td>-74.00377</td>
      <td>18.9</td>
      <td>118.3</td>
      <td>118.0</td>
      <td>TANGIER EXPRESS</td>
      <td>IMO9525900</td>
      <td>5LDS8</td>
      <td>...</td>
      <td>0.0</td>
      <td>366.0</td>
      <td>48.0</td>
      <td>11.5</td>
      <td>74.0</td>
      <td>A</td>
      <td>Cargo, hazardous</td>
      <td>False</td>
      <td>-3285.335787</td>
      <td>-9688.000792</td>
    </tr>
    <tr>
      <th>1487102</th>
      <td>636093148</td>
      <td>2023-08-03 04:24:50</td>
      <td>40.52001</td>
      <td>-73.99690</td>
      <td>19.3</td>
      <td>117.0</td>
      <td>118.0</td>
      <td>TANGIER EXPRESS</td>
      <td>IMO9525900</td>
      <td>5LDS8</td>
      <td>...</td>
      <td>0.0</td>
      <td>366.0</td>
      <td>48.0</td>
      <td>11.5</td>
      <td>74.0</td>
      <td>A</td>
      <td>Cargo, hazardous</td>
      <td>False</td>
      <td>-2703.288068</td>
      <td>-9992.496467</td>
    </tr>
  </tbody>
</table>
<p>131194 rows × 21 columns</p>
</div></div>
</div>
<section id="Visualize-it">
<h3>Visualize it<a class="headerlink" href="#Visualize-it" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MMSIs</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;MMSI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="n">min_observations</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">15</span>  <span class="c1"># warmup + some usage in between + dead_reckoning</span>
<span class="n">relevant_MMSIs</span> <span class="o">=</span> <span class="n">MMSIs</span><span class="p">[</span><span class="n">MMSIs</span> <span class="o">&gt;</span> <span class="n">min_observations</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;MMSI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">relevant_MMSIs</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vessel_type_to_index</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">vessel_type</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">vessel_type</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;VesselTypeName&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
<span class="p">}</span>
<span class="n">palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;tab20&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vessel_type_to_index</span><span class="p">))</span>

<span class="n">all_vessel_types</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;VesselTypeName&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

<span class="n">cols</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">all_rows</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_vessel_types</span><span class="p">)</span> <span class="o">/</span> <span class="n">cols</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="n">cols</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">all_rows</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="p">(</span><span class="n">vessel_type</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">vessel_type_to_index</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()):</span>
    <span class="k">for</span> <span class="n">mmsi</span> <span class="ow">in</span> <span class="n">relevant_MMSIs</span><span class="p">:</span>
        <span class="n">df_</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;MMSI&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">mmsi</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">all_vessel_types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">df_</span><span class="p">[</span><span class="s2">&quot;VesselTypeName&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">vessel_type</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">vessel_type</span> <span class="o">=</span> <span class="n">df_</span><span class="p">[</span><span class="s2">&quot;VesselTypeName&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">palette</span><span class="p">[</span><span class="n">vessel_type_to_index</span><span class="p">[</span><span class="n">vessel_type</span><span class="p">]]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_</span><span class="p">[</span><span class="s2">&quot;LON&quot;</span><span class="p">],</span> <span class="n">df_</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">cols</span> <span class="o">*</span> <span class="p">(</span><span class="n">all_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Longitude&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">cols</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Latitude&quot;</span><span class="p">)</span>

    <span class="n">col</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="n">cols</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="n">cols</span>
    <span class="c1"># if we are in the center, right-hand side</span>
    <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="n">cols</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">row</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_vessel_types</span><span class="p">)</span> <span class="o">//</span> <span class="n">cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">vessel_type</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">vessel_type</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vessel_type_to_index</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">vessel_type_to_index</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Vessel Type&quot;</span><span class="p">,</span>
            <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span>
            <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
        <span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">setting</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_folder</span> <span class="o">/</span> <span class="s2">&quot;ais-all-tracks.pdf&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_37_0.png" src="../_images/notebooks_cofi-maritime_37_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Figure size 1000x400 with 0 Axes&gt;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">relevant_vessel_types</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Cargo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Cargo, hazardous&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Search and rescue vessels&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Towing&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Other&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Tanker&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Tanker, hazardous&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">mmsi</span> <span class="ow">in</span> <span class="n">relevant_MMSIs</span><span class="p">:</span>
    <span class="n">df_</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;MMSI&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">mmsi</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">df_</span><span class="p">[</span><span class="s2">&quot;VesselTypeName&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">relevant_vessel_types</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_</span><span class="p">[</span><span class="s2">&quot;LON&quot;</span><span class="p">],</span> <span class="n">df_</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">output_folder</span> <span class="o">/</span> <span class="s2">&quot;plot-individual-traces&quot;</span> <span class="o">/</span> <span class="n">df_</span><span class="p">[</span><span class="s2">&quot;VesselTypeName&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mmsi</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Figure size 1000x400 with 0 Axes&gt;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># An example of a single vessel</span>
<span class="n">track_mmsi</span> <span class="o">=</span> <span class="mi">636017103</span>
<span class="n">track_mmsi</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
636017103
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;MMSI&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">track_mmsi</span><span class="p">]</span>
<span class="n">df_</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>MMSI</th>
      <th>BaseDateTime</th>
      <th>LAT</th>
      <th>LON</th>
      <th>SOG</th>
      <th>COG</th>
      <th>Heading</th>
      <th>VesselName</th>
      <th>IMO</th>
      <th>CallSign</th>
      <th>...</th>
      <th>Status</th>
      <th>Length</th>
      <th>Width</th>
      <th>Draft</th>
      <th>Cargo</th>
      <th>TransceiverClass</th>
      <th>VesselTypeName</th>
      <th>is_anchoring</th>
      <th>East</th>
      <th>North</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>8684223</th>
      <td>636017103</td>
      <td>2023-08-01 12:42:33</td>
      <td>40.52173</td>
      <td>-73.99979</td>
      <td>14.1</td>
      <td>297.4</td>
      <td>297.0</td>
      <td>MAERSK SKARSTIND</td>
      <td>IMO9740457</td>
      <td>D5JH7</td>
      <td>...</td>
      <td>0.0</td>
      <td>300.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>71.0</td>
      <td>A</td>
      <td>Cargo</td>
      <td>False</td>
      <td>-2948.118757</td>
      <td>-9801.407044</td>
    </tr>
    <tr>
      <th>4277332</th>
      <td>636017103</td>
      <td>2023-08-01 12:43:39</td>
      <td>40.52370</td>
      <td>-74.00477</td>
      <td>14.0</td>
      <td>297.5</td>
      <td>299.0</td>
      <td>MAERSK SKARSTIND</td>
      <td>IMO9740457</td>
      <td>D5JH7</td>
      <td>...</td>
      <td>0.0</td>
      <td>300.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>71.0</td>
      <td>A</td>
      <td>Cargo</td>
      <td>False</td>
      <td>-3370.027333</td>
      <td>-9582.470582</td>
    </tr>
    <tr>
      <th>4289181</th>
      <td>636017103</td>
      <td>2023-08-01 12:44:45</td>
      <td>40.52617</td>
      <td>-74.00927</td>
      <td>13.7</td>
      <td>313.2</td>
      <td>317.0</td>
      <td>MAERSK SKARSTIND</td>
      <td>IMO9740457</td>
      <td>D5JH7</td>
      <td>...</td>
      <td>0.0</td>
      <td>300.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>71.0</td>
      <td>A</td>
      <td>Cargo</td>
      <td>False</td>
      <td>-3751.210309</td>
      <td>-9308.008359</td>
    </tr>
    <tr>
      <th>4296179</th>
      <td>636017103</td>
      <td>2023-08-01 12:45:52</td>
      <td>40.52931</td>
      <td>-74.01278</td>
      <td>13.5</td>
      <td>322.8</td>
      <td>323.0</td>
      <td>MAERSK SKARSTIND</td>
      <td>IMO9740457</td>
      <td>D5JH7</td>
      <td>...</td>
      <td>0.0</td>
      <td>300.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>71.0</td>
      <td>A</td>
      <td>Cargo</td>
      <td>False</td>
      <td>-4048.440577</td>
      <td>-8959.172452</td>
    </tr>
    <tr>
      <th>4301282</th>
      <td>636017103</td>
      <td>2023-08-01 12:46:58</td>
      <td>40.53263</td>
      <td>-74.01607</td>
      <td>13.6</td>
      <td>323.1</td>
      <td>323.0</td>
      <td>MAERSK SKARSTIND</td>
      <td>IMO9740457</td>
      <td>D5JH7</td>
      <td>...</td>
      <td>0.0</td>
      <td>300.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>71.0</td>
      <td>A</td>
      <td>Cargo</td>
      <td>False</td>
      <td>-4326.991573</td>
      <td>-8590.347249</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>4888223</th>
      <td>636017103</td>
      <td>2023-08-03 15:51:38</td>
      <td>40.53210</td>
      <td>-74.01976</td>
      <td>12.4</td>
      <td>144.9</td>
      <td>145.0</td>
      <td>MAERSK SKARSTIND</td>
      <td>IMO9740457</td>
      <td>D5JH7</td>
      <td>...</td>
      <td>0.0</td>
      <td>300.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>71.0</td>
      <td>A</td>
      <td>Cargo</td>
      <td>False</td>
      <td>-4639.669594</td>
      <td>-8649.013395</td>
    </tr>
    <tr>
      <th>4840822</th>
      <td>636017103</td>
      <td>2023-08-03 15:52:40</td>
      <td>40.52912</td>
      <td>-74.01689</td>
      <td>12.6</td>
      <td>142.5</td>
      <td>142.0</td>
      <td>MAERSK SKARSTIND</td>
      <td>IMO9740457</td>
      <td>D5JH7</td>
      <td>...</td>
      <td>0.0</td>
      <td>300.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>71.0</td>
      <td>A</td>
      <td>Cargo</td>
      <td>False</td>
      <td>-4396.696850</td>
      <td>-8980.074135</td>
    </tr>
    <tr>
      <th>4848187</th>
      <td>636017103</td>
      <td>2023-08-03 15:53:50</td>
      <td>40.52634</td>
      <td>-74.01313</td>
      <td>12.3</td>
      <td>126.7</td>
      <td>124.0</td>
      <td>MAERSK SKARSTIND</td>
      <td>IMO9740457</td>
      <td>D5JH7</td>
      <td>...</td>
      <td>0.0</td>
      <td>300.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>71.0</td>
      <td>A</td>
      <td>Cargo</td>
      <td>False</td>
      <td>-4078.276407</td>
      <td>-9288.959375</td>
    </tr>
    <tr>
      <th>4857132</th>
      <td>636017103</td>
      <td>2023-08-03 15:55:50</td>
      <td>40.52297</td>
      <td>-74.00534</td>
      <td>12.3</td>
      <td>117.2</td>
      <td>117.0</td>
      <td>MAERSK SKARSTIND</td>
      <td>IMO9740457</td>
      <td>D5JH7</td>
      <td>...</td>
      <td>0.0</td>
      <td>300.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>71.0</td>
      <td>A</td>
      <td>Cargo</td>
      <td>False</td>
      <td>-3418.365037</td>
      <td>-9663.511281</td>
    </tr>
    <tr>
      <th>4866391</th>
      <td>636017103</td>
      <td>2023-08-03 15:57:38</td>
      <td>40.52014</td>
      <td>-73.99799</td>
      <td>12.7</td>
      <td>116.0</td>
      <td>117.0</td>
      <td>MAERSK SKARSTIND</td>
      <td>IMO9740457</td>
      <td>D5JH7</td>
      <td>...</td>
      <td>0.0</td>
      <td>300.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>71.0</td>
      <td>A</td>
      <td>Cargo</td>
      <td>False</td>
      <td>-2795.652074</td>
      <td>-9978.026678</td>
    </tr>
  </tbody>
</table>
<p>83 rows × 21 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;SOG&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_42_0.png" src="../_images/notebooks_cofi-maritime_42_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_</span><span class="p">[</span><span class="s2">&quot;BaseDateTime&quot;</span><span class="p">])),</span> <span class="n">df_</span><span class="p">[</span><span class="s2">&quot;BaseDateTime&quot;</span><span class="p">])</span>
<span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_43_0.png" src="../_images/notebooks_cofi-maritime_43_0.png" />
</div>
</div>
</section>
<section id="Provide-the-trust-features-to-the-system">
<h3>Provide the trust features to the system<a class="headerlink" href="#Provide-the-trust-features-to-the-system" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>We can read the categorical AIS class directly from the data.</p></li>
<li><p>We compute the binary <code class="docutils literal notranslate"><span class="pre">travels_waterways</span></code> from a simple heuristic.</p></li>
<li><p>We estimate the continous <code class="docutils literal notranslate"><span class="pre">anchoring</span></code> probability using a machine learning model estimated on a hold-out set of data.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;travels_waterways&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;VesselTypeName&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
    <span class="p">[</span><span class="s2">&quot;Tanker&quot;</span><span class="p">,</span> <span class="s2">&quot;Tanker, hazardous&quot;</span><span class="p">,</span> <span class="s2">&quot;Cargo&quot;</span><span class="p">,</span> <span class="s2">&quot;Cargo, hazardous&quot;</span><span class="p">]</span>
<span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Length&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">df</span><span class="p">[</span><span class="s2">&quot;travels_waterways&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
travels_waterways
False    0.965624
True     0.034376
Name: proportion, dtype: float64
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_absolute_error</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neural_network</span><span class="w"> </span><span class="kn">import</span> <span class="n">MLPRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">OneHotEncoder</span><span class="p">,</span> <span class="n">RobustScaler</span>

<span class="n">anchoring_reg</span> <span class="o">=</span> <span class="n">MLPRegressor</span><span class="p">(</span>
    <span class="n">hidden_layer_sizes</span><span class="o">=</span><span class="p">(</span><span class="mi">200</span><span class="p">,),</span>
    <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>  <span class="c1"># L2 regularization</span>
    <span class="n">solver</span><span class="o">=</span><span class="s2">&quot;lbfgs&quot;</span><span class="p">,</span>
    <span class="n">max_iter</span><span class="o">=</span><span class="mi">1_000</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">2025</span><span class="p">,</span>
    <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_reg</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">load_ais</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="s2">&quot;ais&quot;</span> <span class="o">/</span> <span class="s2">&quot;AIS_2023_08_02.csv&quot;</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">bbox</span><span class="p">),</span>
        <span class="n">load_ais</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="s2">&quot;ais&quot;</span> <span class="o">/</span> <span class="s2">&quot;AIS_2023_08_03.csv&quot;</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">bbox</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">one_hot_vessel_type</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">()</span>
<span class="n">length_scaler</span> <span class="o">=</span> <span class="n">RobustScaler</span><span class="p">(</span><span class="n">with_centering</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">speed_scaler</span> <span class="o">=</span> <span class="n">RobustScaler</span><span class="p">(</span><span class="n">with_centering</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">is_fitted</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">def</span><span class="w"> </span><span class="nf">df_to_X</span><span class="p">(</span><span class="n">df_input</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">vessel_type_name</span> <span class="o">=</span> <span class="n">df_input</span><span class="p">[</span><span class="s2">&quot;VesselTypeName&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">df_input</span><span class="p">[</span><span class="s2">&quot;Length&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">speed</span> <span class="o">=</span> <span class="n">df_input</span><span class="p">[</span><span class="s2">&quot;SOG&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">global</span> <span class="n">is_fitted</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_fitted</span><span class="p">:</span>
        <span class="n">one_hot_vessel_type</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">vessel_type_name</span><span class="p">)</span>
        <span class="n">length_scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
        <span class="n">speed_scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>

        <span class="n">is_fitted</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">one_hot_vessel_type</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">vessel_type_name</span><span class="p">)</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span>
            <span class="n">length_scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">length</span><span class="p">),</span>
            <span class="n">speed_scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">speed</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>


<span class="c1"># The input data, also fits the transforms</span>
<span class="n">anchoring_X</span> <span class="o">=</span> <span class="n">df_to_X</span><span class="p">(</span><span class="n">data_reg</span><span class="p">)</span>
<span class="c1"># The target data</span>
<span class="n">anchoring_y</span> <span class="o">=</span> <span class="n">data_reg</span><span class="p">[</span><span class="s2">&quot;is_anchoring&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

<span class="n">anchoring_X</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">anchoring_y</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
((88555, 19), (88555,))
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">anchoring_X</span><span class="p">,</span> <span class="n">anchoring_y</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">2025</span><span class="p">)</span>
<span class="n">anchoring_reg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">anchoring_reg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.04006043728383986
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;is_anchoring_learnt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anchoring_reg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_to_X</span><span class="p">(</span><span class="n">df</span><span class="p">))</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;is_anchoring_learnt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_49_0.png" src="../_images/notebooks_cofi-maritime_49_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_reg</span><span class="p">[</span><span class="s2">&quot;is_anchoring&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
is_anchoring
False    0.97038
True     0.02962
Name: proportion, dtype: float64
</pre></div></div>
</div>
</section>
</section>
<section id="Compute-the-ProMis-landscapes-for-the-ship-categories">
<h2>Compute the ProMis landscapes for the ship categories<a class="headerlink" href="#Compute-the-ProMis-landscapes-for-the-ship-categories" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">landscape_for_mmsi</span><span class="p">(</span>
    <span class="n">mmsi</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">where</span><span class="p">:</span> <span class="n">CartesianCollection</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">return_time</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CartesianCollection</span><span class="p">:</span>
    <span class="c1"># For simplicity, we extract the metadata of the first observation</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;MMSI&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">mmsi</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">specific</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">logic</span><span class="p">)</span>

    <span class="c1"># % Perception from sensors</span>
    <span class="c1"># draught ~ normal(3, 0.5).</span>
    <span class="c1"># 0.1::anchoring.</span>
    <span class="c1"># 0.9::travels_waterways.</span>

    <span class="c1"># % Background knowledge</span>
    <span class="c1"># sufficient_depth(X) :-</span>
    <span class="c1">#     A is depth(X, water), B is draught,</span>
    <span class="c1">#     A + B &lt; -1.5, \+ over(X, land).</span>

    <span class="c1"># 0.95::safe(X) :-</span>
    <span class="c1">#     sufficient_depth(X), distance(X, land) &gt; 50.</span>

    <span class="c1"># proper_anchorage(X) :-</span>
    <span class="c1">#     anchoring, over(X, anchorage);</span>
    <span class="c1">#     \+ anchoring, \+ over(X, anchorage).</span>

    <span class="c1"># 0.90::waterway_preference(X) :-</span>
    <span class="c1">#     travels_waterways, distance(X, waterway) &lt; 400;</span>
    <span class="c1">#     \+ travels_waterways.</span>

    <span class="c1"># % Compliance with Constitution</span>
    <span class="c1"># landscape(X) :-</span>
    <span class="c1">#     proper_anchorage(X), safe(X),</span>
    <span class="c1">#     waterway_preference(X).</span>

    <span class="n">vessel_type</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;VesselTypeName&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">specific</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">is_</span><span class="si">{</span><span class="n">vessel_type</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="k">for</span> <span class="n">vessel_type</span> <span class="ow">in</span> <span class="n">relevant_vessel_types</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">vessel_type</span> <span class="o">!=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;VesselTypeName&quot;</span><span class="p">]:</span>
            <span class="c1"># For clarity, we add a negative fact for all other vessel types</span>
            <span class="n">specific</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">0.0::is_</span><span class="si">{</span><span class="n">vessel_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>

    <span class="c1"># length = metadata[&quot;Length&quot;]</span>
    <span class="c1"># if isfinite(length) and length &gt; 0:</span>
    <span class="c1">#     specific += f&quot;\nlength ~ normal({length}, {length * 0.05}).&quot;</span>
    <span class="c1"># else:</span>
    <span class="c1">#     # Some prior knowledge</span>
    <span class="c1">#     specific += &quot;\nlength ~ normal(30, 10).&quot;</span>

    <span class="k">if</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;travels_waterways&quot;</span><span class="p">]:</span>
        <span class="n">specific</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">0.9::travels_waterways.&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">specific</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">0.1::travels_waterways.&quot;</span>

    <span class="n">probability_is_anchoring</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_anchoring_learnt&quot;</span><span class="p">]</span>
    <span class="n">specific</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">probability_is_anchoring</span><span class="si">}</span><span class="s2">::anchoring.&quot;</span>

    <span class="n">draught</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;Draft&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">isfinite</span><span class="p">(</span><span class="n">draught</span><span class="p">)</span> <span class="ow">and</span> <span class="n">draught</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">specific</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">draught ~ normal(</span><span class="si">{</span><span class="n">draught</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">draught</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.1</span><span class="si">}</span><span class="s2">).&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Some prior knowledge</span>
        <span class="n">specific</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">draught ~ normal(2, 1).&quot;</span>

    <span class="n">specific</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>  <span class="c1"># Add newlines for better readability</span>

    <span class="k">if</span> <span class="n">where</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">specific_support</span> <span class="o">=</span> <span class="n">support</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">specific_support</span> <span class="o">=</span> <span class="n">CartesianCollection</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">number_of_values</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">specific_support</span><span class="o">.</span><span class="n">append_with_default</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">specific_support</span> <span class="o">=</span> <span class="n">where</span>

    <span class="n">before</span> <span class="o">=</span> <span class="n">monotonic</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">promis</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span>
        <span class="n">specific_support</span><span class="p">,</span>
        <span class="n">specific</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">show_progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">print_first</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">after</span> <span class="o">=</span> <span class="n">monotonic</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">return_time</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">,</span> <span class="n">after</span> <span class="o">-</span> <span class="n">before</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="n">landscapes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Cargo&quot;</span><span class="p">:</span> <span class="n">landscape_for_mmsi</span><span class="p">(</span><span class="mi">636017103</span><span class="p">),</span>
    <span class="s2">&quot;Search and rescue vessels&quot;</span><span class="p">:</span> <span class="n">landscape_for_mmsi</span><span class="p">(</span><span class="mi">367531710</span><span class="p">),</span>
    <span class="s2">&quot;Towing&quot;</span><span class="p">:</span> <span class="n">landscape_for_mmsi</span><span class="p">(</span><span class="mi">303461000</span><span class="p">),</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">landscapes</span><span class="p">[</span><span class="s2">&quot;Cargo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_folder</span> <span class="o">/</span> <span class="s2">&quot;landscape-cargo.pkl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">the_support</span> <span class="o">=</span> <span class="n">CartesianRasterBand</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">diff</span> <span class="o">=</span> <span class="n">landscape_for_mmsi</span><span class="p">(</span>
        <span class="mi">636017103</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">the_support</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">return_time</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(6.577459542997531, 0.28954967860355385)
</pre></div></div>
</div>
<section id="Save-them-for-external-use">
<h3>Save them for external use<a class="headerlink" href="#Save-them-for-external-use" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">vessel_type</span><span class="p">,</span> <span class="n">landscape</span> <span class="ow">in</span> <span class="n">landscapes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="c1"># Store the landscape</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">output_folder</span> <span class="o">/</span> <span class="s2">&quot;landscape&quot;</span>
    <span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">landscape</span><span class="o">.</span><span class="n">to_polar</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">vessel_type</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>

    <span class="c1"># Store the trace of the vessels</span>
    <span class="n">df_</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;VesselTypeName&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">vessel_type</span><span class="p">]</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">output_folder</span> <span class="o">/</span> <span class="s2">&quot;ais-trace&quot;</span>
    <span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_</span><span class="p">[[</span><span class="s2">&quot;MMSI&quot;</span><span class="p">,</span> <span class="s2">&quot;LAT&quot;</span><span class="p">,</span> <span class="s2">&quot;LON&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">vessel_type</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Visualize-the-landscapes">
<h3>Visualize the landscapes<a class="headerlink" href="#Visualize-the-landscapes" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This will be used much later</span>
<span class="n">ship_marker</span> <span class="o">=</span> <span class="n">parse_path</span><span class="p">(</span><span class="n">svg2paths</span><span class="p">(</span><span class="s2">&quot;ship-icon.svg&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;d&quot;</span><span class="p">])</span>
<span class="n">ship_marker</span><span class="o">.</span><span class="n">vertices</span> <span class="o">-=</span> <span class="n">ship_marker</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ship_marker</span> <span class="o">=</span> <span class="n">ship_marker</span><span class="o">.</span><span class="n">transformed</span><span class="p">(</span><span class="n">Affine2D</span><span class="p">()</span><span class="o">.</span><span class="n">rotate_deg</span><span class="p">(</span><span class="mi">180</span><span class="p">))</span><span class="o">.</span><span class="n">transformed</span><span class="p">(</span>
    <span class="n">Affine2D</span><span class="p">()</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">vessel_type</span><span class="p">,</span> <span class="n">landscape</span> <span class="ow">in</span> <span class="n">landscapes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">landscape</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">plot_basemap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rasterized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm_r&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>

    <span class="n">df_</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;VesselTypeName&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">vessel_type</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">mmsi</span> <span class="ow">in</span> <span class="n">df_</span><span class="p">[</span><span class="s2">&quot;MMSI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="n">df__</span> <span class="o">=</span> <span class="n">df_</span><span class="p">[</span><span class="n">df_</span><span class="p">[</span><span class="s2">&quot;MMSI&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">mmsi</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df__</span><span class="p">[</span><span class="s2">&quot;East&quot;</span><span class="p">],</span> <span class="n">df__</span><span class="p">[</span><span class="s2">&quot;North&quot;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">vessel_type</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Lowered zoom level to keep map size reasonable. (z = 12)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_59_1.png" src="../_images/notebooks_cofi-maritime_59_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Lowered zoom level to keep map size reasonable. (z = 12)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_59_3.png" src="../_images/notebooks_cofi-maritime_59_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Lowered zoom level to keep map size reasonable. (z = 12)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_59_5.png" src="../_images/notebooks_cofi-maritime_59_5.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Figure size 1000x400 with 0 Axes&gt;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">export</span><span class="p">(</span><span class="n">vessel_type</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">y_axis</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">landscape</span> <span class="o">=</span> <span class="n">landscapes</span><span class="p">[</span><span class="n">vessel_type</span><span class="p">]</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">landscape</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">plot_basemap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rasterized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm_r&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="n">df_</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;VesselTypeName&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">vessel_type</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">mmsi</span> <span class="ow">in</span> <span class="n">df_</span><span class="p">[</span><span class="s2">&quot;MMSI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="n">df__</span> <span class="o">=</span> <span class="n">df_</span><span class="p">[</span><span class="n">df_</span><span class="p">[</span><span class="s2">&quot;MMSI&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">mmsi</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df__</span><span class="p">[</span><span class="s2">&quot;East&quot;</span><span class="p">],</span> <span class="n">df__</span><span class="p">[</span><span class="s2">&quot;North&quot;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
        <span class="c1"># plt.scatter(df__[&quot;East&quot;], df__[&quot;North&quot;], c=df__[&quot;North&quot;], s=1)</span>

    <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s2">&quot;0.0&quot;</span><span class="p">,</span> <span class="s2">&quot;0.5&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">])</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">solids</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">landscape</span><span class="o">.</span><span class="n">dimensions</span>

    <span class="n">xticks</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">yticks</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;20&quot;</span><span class="p">]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Easting / km&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">y_axis</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Northing / km&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([],</span> <span class="p">[])</span>

    <span class="c1"># plt.xlim([-width / 2, width / 2])</span>
    <span class="c1"># plt.ylim([-height / 2, height / 2])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="n">export</span><span class="p">(</span><span class="s2">&quot;Cargo&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">output_folder</span> <span class="o">/</span> <span class="s2">&quot;Cargo.pdf&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">export</span><span class="p">(</span>
    <span class="s2">&quot;Search and rescue vessels&quot;</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="n">output_folder</span> <span class="o">/</span> <span class="s2">&quot;Search and rescue vessels.pdf&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
    <span class="n">y_axis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">export</span><span class="p">(</span><span class="s2">&quot;Towing&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">output_folder</span> <span class="o">/</span> <span class="s2">&quot;Towing.pdf&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">y_axis</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Lowered zoom level to keep map size reasonable. (z = 12)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_60_1.png" src="../_images/notebooks_cofi-maritime_60_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Lowered zoom level to keep map size reasonable. (z = 12)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_60_3.png" src="../_images/notebooks_cofi-maritime_60_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Lowered zoom level to keep map size reasonable. (z = 12)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_60_5.png" src="../_images/notebooks_cofi-maritime_60_5.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">interpolators</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">vessel_type</span><span class="p">:</span> <span class="n">landscape</span><span class="o">.</span><span class="n">get_interpolator</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">vessel_type</span><span class="p">,</span> <span class="n">landscape</span> <span class="ow">in</span> <span class="n">landscapes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">typical_ship_speed</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># meters per second</span>
<span class="n">typical_sample_time</span> <span class="o">=</span> <span class="mi">60</span>  <span class="c1"># seconds</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_trajectories</span><span class="p">(</span><span class="n">all_positions</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;Trajectory </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_positions</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">all_positions</span> <span class="o">=</span> <span class="n">all_positions</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">positions</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_positions</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">positions</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="n">label</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">landscape</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">stack</span><span class="p">((</span><span class="n">df_</span><span class="p">[</span><span class="s2">&quot;East&quot;</span><span class="p">],</span> <span class="n">df_</span><span class="p">[</span><span class="s2">&quot;North&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>
<span class="n">plot_trajectories</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;True trajectory&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Lowered zoom level to keep map size reasonable. (z = 12)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_64_1.png" src="../_images/notebooks_cofi-maritime_64_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Figure size 1000x400 with 0 Axes&gt;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_trajectories_animated</span><span class="p">(</span><span class="n">positions</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;trajectory.gif&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">landscape</span><span class="o">.</span><span class="n">scatter</span><span class="p">()</span>
    <span class="p">(</span><span class="n">line</span><span class="p">,)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">positions</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ship Position&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">line</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="n">num</span><span class="p">],</span> <span class="n">y</span><span class="p">[:</span><span class="n">num</span><span class="p">])</span>
        <span class="n">line</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="o">-</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">line</span><span class="p">,)</span>

    <span class="n">ani</span> <span class="o">=</span> <span class="n">FuncAnimation</span><span class="p">(</span>
        <span class="n">fig</span><span class="p">,</span>
        <span class="n">update</span><span class="p">,</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">),</span>
        <span class="n">fargs</span><span class="o">=</span><span class="p">[</span><span class="n">positions</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">positions</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">line</span><span class="p">],</span>
        <span class="n">interval</span><span class="o">=</span><span class="mi">1000</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span>
        <span class="n">blit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ani</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>


<span class="c1"># plot_trajectories_animated(positions)</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="Implement-CoFi-using-a-particle-filter">
<h2>Implement CoFi using a particle filter<a class="headerlink" href="#Implement-CoFi-using-a-particle-filter" title="Link to this heading"></a></h2>
<p>We directly define the experiments that we will run.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">run_experiment</span><span class="p">(</span>
    <span class="n">ship_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">seed_value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2024</span><span class="p">,</span>
    <span class="n">constitutional_trust</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="n">interpolator</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_initial_particles</span><span class="p">(</span><span class="n">N</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
        <span class="n">typical_ship_speed</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">uniform</span><span class="p">(</span><span class="n">loc</span><span class="o">=-</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">width</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">N</span><span class="p">),</span>  <span class="c1"># x position (east)</span>
                <span class="n">uniform</span><span class="p">(</span><span class="n">loc</span><span class="o">=-</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">height</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">N</span><span class="p">),</span>  <span class="c1"># y position (north)</span>
                <span class="c1"># uniform(loc=0, scale=2 * pi).rvs(N),  # heading</span>
                <span class="c1"># norm(loc=5, scale=3).rvs(N),  # speed</span>
                <span class="n">norm</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">typical_ship_speed</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">N</span><span class="p">),</span>
                <span class="n">norm</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">typical_ship_speed</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">N</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">process_noise</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;move according to control input u (heading change, velocity)</span>
<span class="sd">        with noise Q (std heading change, std velocity)`&quot;&quot;&quot;</span>

        <span class="n">particles</span> <span class="o">=</span> <span class="n">particles</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">particles</span><span class="p">)</span>

        <span class="c1"># ##################################</span>
        <span class="c1"># # We first add noise to the heading</span>
        <span class="c1"># particles[:, 2] += deg2rad(</span>
        <span class="c1">#     standard_normal(N)  # we can turn 2 degrees per second in each direction (95% interval)</span>
        <span class="c1"># )</span>
        <span class="c1"># particles[:, 2] %= 2 * pi</span>

        <span class="c1"># # Add noise to the speed</span>
        <span class="c1"># particles[:, 3] += standard_normal(N) * 0.1</span>
        <span class="c1"># particles[:, 3] = np.clip(particles[:, 3], 0, 12)</span>

        <span class="c1"># # Compute the actual distance we travel</span>
        <span class="c1"># distance = particles[:, 3] * dt</span>
        <span class="c1"># particles[:, 0] += np.cos(particles[:, 2]) * distance</span>
        <span class="c1"># particles[:, 1] += np.sin(particles[:, 2]) * distance</span>
        <span class="c1"># # TODO: possibly also add noise to the heading</span>
        <span class="c1"># ##################################</span>

        <span class="c1"># noise = standard_normal(N) * std[1]</span>
        <span class="c1"># particles[:, [0, 1]] += particles[:, [2, 3]] * dt + noise</span>

        <span class="c1"># ##################################</span>

        <span class="n">scaled_process_noise</span> <span class="o">=</span> <span class="n">process_noise</span> <span class="o">*</span> <span class="n">dt</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">particles</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">particles</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span>

        <span class="n">p_next</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="n">v_next</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">scaled_process_noise</span><span class="p">,</span> <span class="n">scaled_process_noise</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">particles</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">p_next</span>
        <span class="n">particles</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">v_next</span>

        <span class="k">return</span> <span class="n">particles</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span>
        <span class="n">particles</span><span class="p">,</span>
        <span class="n">weights</span><span class="p">,</span>
        <span class="n">z</span><span class="p">,</span>
        <span class="n">R</span><span class="p">,</span>
        <span class="n">dt</span><span class="p">,</span>
        <span class="n">constitutional_trust</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">constitutional_trust</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">positions</span> <span class="o">=</span> <span class="n">particles</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">positions</span> <span class="o">-</span> <span class="n">z</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Evaluate an RBF kernel</span>
        <span class="c1"># weights *= np.exp(-(distance**2) / (2 * R**2))</span>
        <span class="c1"># print(distance.shape)</span>
        <span class="c1"># print(R)</span>
        <span class="c1"># print(z.shape)</span>
        <span class="c1"># weights *= norm(distance, R).pdf(distance)</span>
        <span class="c1"># weights *= norm(0, R).pdf(distance)</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">*=</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">R</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span>
        <span class="c1"># weights *= norm(positions, R).pdf(z)</span>

        <span class="k">if</span> <span class="n">constitutional_trust</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># if landscape is None:</span>
            <span class="c1">#     # take a random subset of positions</span>
            <span class="c1">#     sampled_positions = positions[np.random.choice(len(positions), 100, replace=False)]</span>
            <span class="c1">#     this_landscape = landscape_for_mmsi(</span>
            <span class="c1">#         ship_df[&quot;MMSI&quot;].iloc[0], where=sampled_positions, n_jobs=None</span>
            <span class="c1">#     )</span>
            <span class="c1">#     this_interpolator.get_interpolator()</span>
            <span class="c1"># else:</span>
            <span class="c1">#     this_interpolator = interpolator</span>
            <span class="n">this_interpolator</span> <span class="o">=</span> <span class="n">interpolator</span>
            <span class="n">constitution</span> <span class="o">=</span> <span class="n">this_interpolator</span><span class="p">(</span><span class="n">positions</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">weight_change</span> <span class="o">=</span> <span class="n">constitutional_trust</span> <span class="o">*</span> <span class="n">constitution</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">constitutional_trust</span><span class="p">)</span>
            <span class="c1"># Disallow going to placed where the constitution is not even defined</span>
            <span class="n">weight_change</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">constitution</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">weights</span> <span class="o">*=</span> <span class="n">weight_change</span>

        <span class="n">weights</span> <span class="o">+=</span> <span class="mf">1.0e-300</span>  <span class="c1"># avoid round-off to zero</span>
        <span class="n">weights</span> <span class="o">/=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>  <span class="c1"># normalize</span>

        <span class="k">return</span> <span class="n">weights</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">estimate</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;returns mean and variance of the weighted particles&quot;&quot;&quot;</span>

        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">particles</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mean</span><span class="p">,</span> <span class="n">var</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">neff</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">resample_from_index</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">indexes</span><span class="p">):</span>
        <span class="n">particles</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">particles</span><span class="p">[</span><span class="n">indexes</span><span class="p">]</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">particles</span><span class="p">))</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_pf1</span><span class="p">(</span>
        <span class="n">N</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">sensor_std_err</span><span class="p">,</span>
        <span class="n">process_noise</span><span class="p">,</span>
        <span class="n">do_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">plot_particles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">plot_every</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">do_plot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

        <span class="c1"># Create particles uniformly over the entire space</span>
        <span class="n">particles</span> <span class="o">=</span> <span class="n">create_initial_particles</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>

        <span class="c1"># However, for the location we can do a bit better by assuming that the current</span>
        <span class="c1"># observation is approximately correct</span>
        <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span>
        <span class="n">particles</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">particles</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>

        <span class="c1"># create weights</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>

        <span class="k">if</span> <span class="n">do_plot</span> <span class="ow">and</span> <span class="n">plot_particles</span><span class="p">:</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.20</span>
            <span class="k">if</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">5000</span><span class="p">:</span>
                <span class="n">alpha</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">5000</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">particles</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">particles</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">weights_trace</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">particle_trace</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">obs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

            <span class="c1"># move</span>
            <span class="n">particles</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">process_noise</span><span class="o">=</span><span class="n">process_noise</span><span class="p">)</span>

            <span class="c1"># incorporate measurements</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">obs</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">R</span><span class="o">=</span><span class="n">sensor_std_err</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>

            <span class="c1"># resample if too few effective particles</span>
            <span class="k">if</span> <span class="n">neff</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">N</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">indexes</span> <span class="o">=</span> <span class="n">systematic_resample</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
                <span class="n">resample_from_index</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">indexes</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">N</span><span class="p">)</span>

            <span class="n">mu</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">estimate</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
            <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>

            <span class="n">weights_trace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="n">particle_trace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">particles</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">do_plot</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">%</span> <span class="n">plot_every</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">plot_particles</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">particles</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">particles</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
                <span class="c1"># draw a cricle perimeter at 1 std</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">mu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mu</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">radius</span><span class="o">=</span><span class="n">sensor_std_err</span> <span class="o">*</span> <span class="n">dt</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">p1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">obs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
                <span class="n">p2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mu</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_plot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;Actual&quot;</span><span class="p">,</span> <span class="s2">&quot;PF&quot;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">numpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">pos_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">xs</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">all_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">xs</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">do_plot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;particles&quot;</span><span class="p">:</span> <span class="n">array</span><span class="p">(</span><span class="n">particle_trace</span><span class="p">),</span>
            <span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="n">array</span><span class="p">(</span><span class="n">weights_trace</span><span class="p">),</span>
            <span class="s2">&quot;estimates&quot;</span><span class="p">:</span> <span class="n">xs</span><span class="p">,</span>
            <span class="s2">&quot;pos_error&quot;</span><span class="p">:</span> <span class="n">pos_error</span><span class="p">,</span>
            <span class="s2">&quot;pos_error_mean&quot;</span><span class="p">:</span> <span class="n">pos_error</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s2">&quot;all_error&quot;</span><span class="p">:</span> <span class="n">all_error</span><span class="p">,</span>
            <span class="s2">&quot;all_error_mean&quot;</span><span class="p">:</span> <span class="n">all_error</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s2">&quot;truth&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">ship_df</span> <span class="o">=</span> <span class="n">ship_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">ship_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;RelativeTime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ship_df</span><span class="p">[</span><span class="s2">&quot;BaseDateTime&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ship_df</span><span class="p">[</span><span class="s2">&quot;BaseDateTime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">ship_df</span><span class="p">[</span><span class="s2">&quot;RelativeTime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">is_monotonic_increasing</span>

    <span class="n">ground_truth</span> <span class="o">=</span> <span class="n">stack</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">ship_df</span><span class="p">[</span><span class="s2">&quot;East&quot;</span><span class="p">],</span>
            <span class="n">ship_df</span><span class="p">[</span><span class="s2">&quot;North&quot;</span><span class="p">],</span>
            <span class="n">deg2rad</span><span class="p">(</span><span class="n">ship_df</span><span class="p">[</span><span class="s2">&quot;COG&quot;</span><span class="p">]),</span>
            <span class="n">ship_df</span><span class="p">[</span><span class="s2">&quot;SOG&quot;</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ship_df</span><span class="p">[</span><span class="s2">&quot;RelativeTime&quot;</span><span class="p">],</span> <span class="n">prepend</span><span class="o">=</span><span class="n">ship_df</span><span class="p">[</span><span class="s2">&quot;RelativeTime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="n">seed</span><span class="p">(</span><span class="n">seed_value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">run_pf1</span><span class="p">(</span>
        <span class="n">N</span><span class="o">=</span><span class="mi">2_000</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">ground_truth</span><span class="p">,</span>
        <span class="n">sensor_std_err</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">process_noise</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
    <span class="p">)</span>


<span class="n">res_specific</span> <span class="o">=</span> <span class="n">run_experiment</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;MMSI&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">track_mmsi</span><span class="p">],</span>
    <span class="n">seed_value</span><span class="o">=</span><span class="mi">2025</span><span class="p">,</span>
    <span class="n">constitutional_trust</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">interpolator</span><span class="o">=</span><span class="n">interpolators</span><span class="p">[</span><span class="s2">&quot;Cargo&quot;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plt.figure(figsize=(6, 4))</span>
<span class="c1"># bg = landscape.scatter(alpha=0.5, plot_basemap=False)</span>
<span class="c1"># plot_trajectories(res_specific[&quot;truth&quot;][:, :2], label=&quot;True trajectory&quot;, color=&quot;b&quot;)</span>
<span class="c1"># plot_trajectories(res_specific[&quot;estimates&quot;][:, :2], label=&quot;Estimated trajectory (CoFi)&quot;, color=&quot;g&quot;)</span>
<span class="c1"># pass</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">relevant_MMSIs</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">df_for_type</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;VesselTypeName&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">landscapes</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
<span class="n">df_for_type</span> <span class="o">=</span> <span class="n">df_for_type</span><span class="p">[</span><span class="n">df_for_type</span><span class="p">[</span><span class="s2">&quot;MMSI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">relevant_MMSIs</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">mmsi</span> <span class="ow">in</span> <span class="n">track</span><span class="p">(</span><span class="n">relevant_MMSIs</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;MMSIs&quot;</span><span class="p">):</span>
    <span class="c1"># Skip if we have no data for that ship</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">df_for_type</span><span class="p">[</span><span class="n">df_for_type</span><span class="p">[</span><span class="s2">&quot;MMSI&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">mmsi</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="k">for</span> <span class="n">manual_seed</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2023</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">tau</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">):</span>
            <span class="n">vessel_type</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;VesselTypeName&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">experiment_result</span> <span class="o">=</span> <span class="n">run_experiment</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span>
                <span class="n">constitutional_trust</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span>
                <span class="n">seed_value</span><span class="o">=</span><span class="n">manual_seed</span><span class="p">,</span>
                <span class="n">interpolator</span><span class="o">=</span><span class="n">interpolators</span><span class="p">[</span><span class="n">vessel_type</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">mmsi</span><span class="o">=</span><span class="n">mmsi</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">vessel_type</span><span class="p">,</span>
                    <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span>
                    <span class="n">seed</span><span class="o">=</span><span class="n">manual_seed</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">experiment_result</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

<span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="n">df_results</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># before = monotonic()</span>
<span class="c1"># run_experiment(</span>
<span class="c1">#     data[:20],</span>
<span class="c1">#     constitutional_trust=0.5,</span>
<span class="c1">#     seed_value=2024,</span>
<span class="c1">#     interpolator=interpolator,</span>
<span class="c1">#     full_inference=False,</span>
<span class="c1">#     use_constitution=True,</span>
<span class="c1"># )</span>
<span class="c1"># after = monotonic()</span>
<span class="c1"># after - before</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_results</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s2">&quot;res-all-taus.pkl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s2">&quot;res-all-taus.pkl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_results</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">()</span>
<span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_74_0.png" src="../_images/notebooks_cofi-maritime_74_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For identifying interesting cases</span>
<span class="n">with_benefit</span> <span class="o">=</span> <span class="n">df_results</span><span class="o">.</span><span class="n">copy</span><span class="p">()[(</span><span class="n">df_results</span><span class="p">[</span><span class="s2">&quot;tau&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df_results</span><span class="p">[</span><span class="s2">&quot;tau&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)]</span>

<span class="n">with_benefit</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">with_benefit</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;mmsi&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">group</span><span class="p">:</span> <span class="n">group</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span>
            <span class="p">(</span>
                <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s2">&quot;tau&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="o">|</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s2">&quot;tau&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span>
                        <span class="c1"># The best in the group</span>
                        <span class="n">group</span><span class="p">[</span><span class="s2">&quot;pos_error_mean&quot;</span><span class="p">]</span>
                        <span class="o">==</span> <span class="n">group</span><span class="p">[</span><span class="n">group</span><span class="p">[</span><span class="s2">&quot;tau&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">][</span><span class="s2">&quot;pos_error_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># # TODO: for the interesting cases</span>
            <span class="c1"># &amp; (group[&quot;pos_error_mean&quot;] &lt; group[&quot;pos_error_mean&quot;].quantile(0.3).item())</span>
        <span class="p">]</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">benefit</span><span class="o">=</span><span class="p">(</span>
                <span class="n">group</span><span class="p">[</span><span class="n">group</span><span class="p">[</span><span class="s2">&quot;tau&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">][</span><span class="s2">&quot;pos_error_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="o">-</span> <span class="n">group</span><span class="p">[</span><span class="n">group</span><span class="p">[</span><span class="s2">&quot;tau&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">][</span><span class="s2">&quot;pos_error_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">relative_error</span><span class="o">=</span><span class="p">(</span>
                <span class="n">group</span><span class="p">[</span><span class="s2">&quot;pos_error_mean&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">group</span><span class="p">[</span><span class="n">group</span><span class="p">[</span><span class="s2">&quot;tau&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">][</span><span class="s2">&quot;pos_error_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;tau&quot;</span><span class="p">),</span>
        <span class="n">include_groups</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">with_benefit</span><span class="p">[</span><span class="s2">&quot;benefit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_76_0.png" src="../_images/notebooks_cofi-maritime_76_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">with_benefit_strong</span> <span class="o">=</span> <span class="n">with_benefit</span><span class="p">[</span><span class="n">with_benefit</span><span class="p">[</span><span class="s2">&quot;benefit&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

<span class="n">only_tau_nonzero</span> <span class="o">=</span> <span class="n">with_benefit_strong</span><span class="p">[</span><span class="n">with_benefit_strong</span><span class="p">[</span><span class="s2">&quot;tau&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">]</span>
<span class="n">decent_mmsis</span> <span class="o">=</span> <span class="n">only_tau_nonzero</span><span class="p">[</span>
    <span class="p">(</span><span class="n">only_tau_nonzero</span><span class="p">[</span><span class="s2">&quot;relative_error&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">only_tau_nonzero</span><span class="p">[</span><span class="s2">&quot;relative_error&quot;</span><span class="p">])</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">only_tau_nonzero</span><span class="p">[</span><span class="s2">&quot;relative_error&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">only_tau_nonzero</span><span class="p">[</span><span class="s2">&quot;relative_error&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
<span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">with_benefit_strong</span> <span class="o">=</span> <span class="n">with_benefit_strong</span><span class="p">[</span><span class="n">with_benefit_strong</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">decent_mmsis</span><span class="p">)]</span>

<span class="n">results_mmsis</span> <span class="o">=</span> <span class="n">with_benefit_strong</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="nb">len</span><span class="p">(</span><span class="n">results_mmsis</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
5
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">chosen_mmsi</span> <span class="o">=</span> <span class="n">results_mmsis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">with_benefit_strong</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">chosen_mmsi</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;tau&quot;</span><span class="p">)</span>

<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
<span class="k">assert</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;tau&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span>
<span class="k">assert</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;tau&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
<span class="n">result_pf</span><span class="p">,</span> <span class="n">result_cofi</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">result_cofi</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mmsi: </span><span class="si">{</span><span class="n">chosen_mmsi</span><span class="si">}</span><span class="s2"> @ tau: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">result_cofi_all_taus</span> <span class="o">=</span> <span class="n">df_results</span><span class="p">[</span><span class="n">df_results</span><span class="p">[</span><span class="s2">&quot;mmsi&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">chosen_mmsi</span><span class="p">]</span>

<span class="p">(</span>
    <span class="n">result_pf</span><span class="p">[</span><span class="s2">&quot;pos_error_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
    <span class="n">result_cofi</span><span class="p">[</span><span class="s2">&quot;pos_error_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
    <span class="n">result_cofi</span><span class="p">[</span><span class="s2">&quot;benefit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
    <span class="n">result_cofi</span><span class="p">[</span><span class="s2">&quot;relative_error&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
mmsi: 366962130 @ tau: 1.0
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(4207482.0687188385, 3499828.96697912, 707653.1017397186, 0.8318107860753887)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # Show how the weights change over time</span>
<span class="c1"># for i in range(50):</span>
<span class="c1">#     plt.plot(weights[:, i])</span>
<span class="c1"># plt.show()</span>
<span class="c1"># plt.clf()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">bg</span> <span class="o">=</span> <span class="n">landscape</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">plot_basemap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plot_trajectories</span><span class="p">(</span><span class="n">result_pf</span><span class="p">[</span><span class="s2">&quot;truth&quot;</span><span class="p">][:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;True trajectory&quot;</span><span class="p">)</span>
<span class="n">plot_trajectories</span><span class="p">(</span><span class="n">result_pf</span><span class="p">[</span><span class="s2">&quot;estimates&quot;</span><span class="p">][:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Estimated trajectory (PF)&quot;</span><span class="p">)</span>
<span class="n">plot_trajectories</span><span class="p">(</span><span class="n">result_cofi</span><span class="p">[</span><span class="s2">&quot;estimates&quot;</span><span class="p">][:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Estimated trajectory (CoFi)&quot;</span><span class="p">)</span>

<span class="c1"># Mark the starting point</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">result_pf</span><span class="p">[</span><span class="s2">&quot;truth&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="n">result_pf</span><span class="p">[</span><span class="s2">&quot;truth&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">marker</span><span class="o">=</span><span class="n">ship_marker</span><span class="p">,</span>
    <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Start&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># show_n_particles = 10</span>
<span class="c1"># plot_trajectories(trace_all_particles[:, :show_n_particles, :2].swapaxes(1, 0), label=None)</span>

<span class="n">all_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
    <span class="p">[</span><span class="n">result_pf</span><span class="p">[</span><span class="s2">&quot;truth&quot;</span><span class="p">][:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">result_pf</span><span class="p">[</span><span class="s2">&quot;estimates&quot;</span><span class="p">][:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">result_cofi</span><span class="p">[</span><span class="s2">&quot;estimates&quot;</span><span class="p">][:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]]</span>
<span class="p">)</span>
<span class="n">scale</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>

<span class="c1"># Move legend to the right of the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="c1"># move_legend(plt.gca(), loc=&quot;center left&quot;, bbox_to_anchor=(1.3, 0.5))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">bg</span><span class="p">)</span>
<span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">start</span> <span class="o">=</span> <span class="mi">119</span>
<span class="n">end</span> <span class="o">=</span> <span class="mi">131</span>
<span class="n">length</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>

<span class="c1"># taus = sorted(set(df_results[&quot;tau&quot;].unique()) - {0.0})</span>
<span class="n">taus</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>

<span class="n">all_result_cofi</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">tau</span><span class="p">:</span> <span class="n">result_cofi_all_taus</span><span class="p">[</span>
        <span class="p">(</span><span class="n">result_cofi_all_taus</span><span class="p">[</span><span class="s2">&quot;mmsi&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">chosen_mmsi</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">((</span><span class="n">result_cofi_all_taus</span><span class="p">[</span><span class="s2">&quot;tau&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">tau</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">)</span>
    <span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">tau</span> <span class="ow">in</span> <span class="n">taus</span>
<span class="p">}</span>

<span class="n">c_true</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;tab10&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">c_pf</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;tab10&quot;</span><span class="p">)[</span><span class="mi">4</span><span class="p">]</span>
<span class="n">c_cofi</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;tab10&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">cofi_alphas</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mf">0.1</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
    <span class="mf">0.5</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">,</span>
    <span class="mf">1.0</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_trajectories_</span><span class="p">(</span><span class="n">all_positions</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_positions</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">all_positions</span> <span class="o">=</span> <span class="n">all_positions</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">positions</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_positions</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">positions</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="n">label</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="c1"># bg = landscape.scatter(alpha=0.5, plot_basemap=True, zoom=14)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
    <span class="n">landscape</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">)),</span>
    <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
    <span class="n">extent</span><span class="o">=</span><span class="n">landscape</span><span class="o">.</span><span class="n">extent</span><span class="p">(),</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm_r&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">rasterized</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Because the extend is not large</span>
    <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;bicubic&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">lw</span> <span class="o">=</span> <span class="mi">3</span>
<span class="p">(</span><span class="n">line_track_true</span><span class="p">,)</span> <span class="o">=</span> <span class="n">plot_trajectories_</span><span class="p">(</span>
    <span class="n">result_pf</span><span class="p">[</span><span class="s2">&quot;truth&quot;</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;True Trajectory&quot;</span><span class="p">,</span>
    <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span>
    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
    <span class="n">markersize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="n">c_true</span><span class="p">,</span>
<span class="p">)</span>
<span class="p">(</span><span class="n">line_track_pf</span><span class="p">,)</span> <span class="o">=</span> <span class="n">plot_trajectories_</span><span class="p">(</span>
    <span class="n">result_pf</span><span class="p">[</span><span class="s2">&quot;estimates&quot;</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Estimate (Particle Filter)&quot;</span><span class="p">,</span>
    <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span>
    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
    <span class="n">markersize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="n">c_pf</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">line_tracks_cofi</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">tau</span> <span class="ow">in</span> <span class="n">taus</span><span class="p">:</span>
    <span class="p">(</span><span class="n">line</span><span class="p">,)</span> <span class="o">=</span> <span class="n">plot_trajectories_</span><span class="p">(</span>
        <span class="n">all_result_cofi</span><span class="p">[</span><span class="n">tau</span><span class="p">][</span><span class="s2">&quot;estimates&quot;</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">rf</span><span class="s2">&quot;Estimate (CoFi) @ $\tau=</span><span class="si">{</span><span class="n">tau</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">,</span>
        <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
        <span class="n">markersize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">c_cofi</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">cofi_alphas</span><span class="p">[</span><span class="n">tau</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">line_tracks_cofi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

<span class="c1"># Annotate the steps in the ground thruth</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">result_cofi</span><span class="p">[</span><span class="s2">&quot;particles&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">result_cofi</span><span class="p">[</span><span class="s2">&quot;particles&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">s</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Easting / m&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Northing / m&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">7000</span><span class="p">,</span> <span class="o">-</span><span class="mi">5000</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">time_scale</span> <span class="o">=</span> <span class="mf">60.0</span>
<span class="n">time_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="o">*</span> <span class="n">time_scale</span>
<span class="n">err_pf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
    <span class="n">result_pf</span><span class="p">[</span><span class="s2">&quot;truth&quot;</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">result_pf</span><span class="p">[</span><span class="s2">&quot;estimates&quot;</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
<span class="p">(</span><span class="n">line_pf_error</span><span class="p">,)</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">time_steps</span><span class="p">,</span>
    <span class="n">err_pf</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Particle Filter&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="n">c_pf</span><span class="p">,</span>
    <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">errs_cofi</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">line_err_cofi</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">tau</span> <span class="ow">in</span> <span class="n">taus</span><span class="p">:</span>
    <span class="n">err_cofi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
        <span class="n">result_cofi</span><span class="p">[</span><span class="s2">&quot;truth&quot;</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">all_result_cofi</span><span class="p">[</span><span class="n">tau</span><span class="p">][</span><span class="s2">&quot;estimates&quot;</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">errs_cofi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_cofi</span><span class="p">)</span>
    <span class="p">(</span><span class="n">line</span><span class="p">,)</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">time_steps</span><span class="p">,</span>
        <span class="n">err_cofi</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">rf</span><span class="s2">&quot;CoFi @ $\tau=</span><span class="si">{</span><span class="n">tau</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">cofi_alphas</span><span class="p">[</span><span class="n">tau</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="n">c_cofi</span><span class="p">,</span>
        <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">line_err_cofi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">time_steps</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">time_steps</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">time_steps</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time / s&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Tracking Error / m&quot;</span><span class="p">)</span>
<span class="c1"># axes[1].legend()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="n">line_track_true</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span>
        <span class="n">result_pf</span><span class="p">[</span><span class="s2">&quot;truth&quot;</span><span class="p">][</span><span class="n">start</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">result_pf</span><span class="p">[</span><span class="s2">&quot;truth&quot;</span><span class="p">][</span><span class="n">start</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">line_track_pf</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span>
        <span class="n">result_pf</span><span class="p">[</span><span class="s2">&quot;estimates&quot;</span><span class="p">][</span><span class="n">start</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">result_pf</span><span class="p">[</span><span class="s2">&quot;estimates&quot;</span><span class="p">][</span><span class="n">start</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">line_pf_error</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">time_steps</span><span class="p">[:</span> <span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">err_pf</span><span class="p">[:</span> <span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">line_track</span><span class="p">,</span> <span class="n">line_err</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">taus</span><span class="p">,</span> <span class="n">line_tracks_cofi</span><span class="p">,</span> <span class="n">line_err_cofi</span><span class="p">)):</span>
        <span class="c1"># make sure that the old tau thing stay shown</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">taus</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">length</span> <span class="o">&lt;=</span> <span class="n">num</span><span class="p">:</span>
            <span class="n">l_num</span> <span class="o">=</span> <span class="n">length</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l_num</span> <span class="o">=</span> <span class="n">num</span> <span class="o">%</span> <span class="n">length</span>

        <span class="n">line_track</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span>
            <span class="n">all_result_cofi</span><span class="p">[</span><span class="n">tau</span><span class="p">][</span><span class="s2">&quot;estimates&quot;</span><span class="p">][</span><span class="n">start</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">l_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">all_result_cofi</span><span class="p">[</span><span class="n">tau</span><span class="p">][</span><span class="s2">&quot;estimates&quot;</span><span class="p">][</span><span class="n">start</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">l_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">err_cofi</span> <span class="o">=</span> <span class="n">errs_cofi</span><span class="p">[</span><span class="n">taus</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">tau</span><span class="p">)]</span>
        <span class="n">line_err</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">time_steps</span><span class="p">[:</span> <span class="n">l_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">err_cofi</span><span class="p">[:</span> <span class="n">l_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">line_track_true</span><span class="p">,</span> <span class="n">line_track_pf</span><span class="p">,</span> <span class="n">line_pf_error</span><span class="p">,</span> <span class="o">*</span><span class="n">line_tracks_cofi</span><span class="p">,</span> <span class="o">*</span><span class="n">line_err_cofi</span><span class="p">)</span>


<span class="n">ani</span> <span class="o">=</span> <span class="n">FuncAnimation</span><span class="p">(</span>
    <span class="n">fig</span><span class="p">,</span>
    <span class="n">update</span><span class="p">,</span>
    <span class="n">length</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">taus</span><span class="p">),</span>
    <span class="c1"># fargs=[positions[:, 0], positions[:, 1], line],</span>
    <span class="n">interval</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">blit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ani</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;for_video.gif&quot;</span><span class="p">)</span>
<span class="c1"># ani.save(&quot;for_video.mp4&quot;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">errs_cofi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">err_pf</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">errs_cofi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">err_pf</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</pre></div>
</div>
</div>
<section id="Visualize-using-Kepler.gl">
<h3>Visualize using Kepler.gl<a class="headerlink" href="#Visualize-using-Kepler.gl" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[67]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">cartesian_to_polar</span><span class="p">(</span><span class="n">coords</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
    <span class="n">collection</span> <span class="o">=</span> <span class="n">CartesianCollection</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">number_of_values</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">collection</span><span class="o">.</span><span class="n">append_with_default</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">collection</span><span class="o">.</span><span class="n">to_polar</span><span class="p">()</span><span class="o">.</span><span class="n">coordinates</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">make_line_string</span><span class="p">(</span><span class="n">cartesian_coords</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;LineString&quot;</span><span class="p">,</span>
            <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="n">cartesian_to_polar</span><span class="p">(</span><span class="n">cartesian_coords</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="p">}</span>
    <span class="p">)</span>


<span class="n">start_date</span> <span class="o">=</span> <span class="s2">&quot;2023-08-01 0:0:00&quot;</span>
<span class="n">date_format</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> </span><span class="si">%X</span><span class="s2">&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">make_route_points</span><span class="p">(</span><span class="n">cartesian_coords</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Args:</span>
<span class="sd">        cartesian_coords: Shape (T, 2)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;FeatureCollection&quot;</span><span class="p">,</span>
            <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Point&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="n">coord</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">time</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">cartesian_to_polar</span><span class="p">(</span><span class="n">cartesian_coords</span><span class="p">),</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">cartesian_coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
                        <span class="n">date_format</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="p">],</span>
        <span class="p">}</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">make_particles</span><span class="p">(</span><span class="n">cartesian_coords</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Args:</span>
<span class="sd">        cartesian_coords: Shape (T, N, 2)</span>
<span class="sd">        weights: Shape (T, N)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;FeatureCollection&quot;</span><span class="p">,</span>
            <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Point&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="n">coord</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span>
                        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">coords_t</span><span class="p">,</span> <span class="n">weights_t</span><span class="p">,</span> <span class="n">time</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">cartesian_coords</span><span class="p">,</span>
                    <span class="n">weights</span><span class="p">,</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">cartesian_coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
                        <span class="n">date_format</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">cartesian_to_polar</span><span class="p">(</span><span class="n">coords_t</span><span class="p">),</span>
                    <span class="n">weights_t</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                <span class="p">)</span>
            <span class="p">],</span>
        <span class="p">}</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">subsample_particles</span> <span class="o">=</span> <span class="mi">4</span>
<span class="nb">map</span> <span class="o">=</span> <span class="n">KeplerGl</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;True Trajectory Track&quot;</span><span class="p">:</span> <span class="n">make_line_string</span><span class="p">(</span><span class="n">result_pf</span><span class="p">[</span><span class="s2">&quot;truth&quot;</span><span class="p">][:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]),</span>
        <span class="s2">&quot;True Trajectory&quot;</span><span class="p">:</span> <span class="n">make_route_points</span><span class="p">(</span><span class="n">result_pf</span><span class="p">[</span><span class="s2">&quot;truth&quot;</span><span class="p">][:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]),</span>
        <span class="c1">#</span>
        <span class="s2">&quot;Estimated Trajectory (CoFi) Track&quot;</span><span class="p">:</span> <span class="n">make_line_string</span><span class="p">(</span><span class="n">result_cofi</span><span class="p">[</span><span class="s2">&quot;estimates&quot;</span><span class="p">][:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]),</span>
        <span class="s2">&quot;Estimated Trajectory (CoFi)&quot;</span><span class="p">:</span> <span class="n">make_route_points</span><span class="p">(</span><span class="n">result_cofi</span><span class="p">[</span><span class="s2">&quot;estimates&quot;</span><span class="p">][:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]),</span>
        <span class="c1">#</span>
        <span class="s2">&quot;Estimated Trajectory (PF) Track&quot;</span><span class="p">:</span> <span class="n">make_line_string</span><span class="p">(</span><span class="n">result_pf</span><span class="p">[</span><span class="s2">&quot;estimates&quot;</span><span class="p">][:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]),</span>
        <span class="s2">&quot;Estimated Trajectory (PF)&quot;</span><span class="p">:</span> <span class="n">make_route_points</span><span class="p">(</span><span class="n">result_pf</span><span class="p">[</span><span class="s2">&quot;estimates&quot;</span><span class="p">][:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]),</span>
        <span class="c1">#</span>
        <span class="s2">&quot;Particles (PF)&quot;</span><span class="p">:</span> <span class="n">make_particles</span><span class="p">(</span>
            <span class="n">result_pf</span><span class="p">[</span><span class="s2">&quot;particles&quot;</span><span class="p">][:,</span> <span class="p">:</span><span class="n">subsample_particles</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">result_pf</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">][:,</span> <span class="p">:</span><span class="n">subsample_particles</span><span class="p">],</span>
        <span class="p">),</span>
        <span class="s2">&quot;Particles (CoFi)&quot;</span><span class="p">:</span> <span class="n">make_particles</span><span class="p">(</span>
            <span class="n">result_cofi</span><span class="p">[</span><span class="s2">&quot;particles&quot;</span><span class="p">][:,</span> <span class="p">:</span><span class="n">subsample_particles</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">result_cofi</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">][:,</span> <span class="p">:</span><span class="n">subsample_particles</span><span class="p">],</span>
        <span class="p">),</span>
    <span class="p">},</span>
    <span class="n">config</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;v1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;mapState&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="n">cartesian_to_polar</span><span class="p">(</span><span class="n">all_coords</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="n">cartesian_to_polar</span><span class="p">(</span><span class="n">all_coords</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                <span class="s2">&quot;zoom&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;visState&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;dataId&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">data_field</span><span class="p">],</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;94q7ipgwi-</span><span class="si">{</span><span class="n">data_field</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;DateTime&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;yAxis&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s2">&quot;speed&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="k">for</span> <span class="n">data_field</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="s2">&quot;True Trajectory&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Estimated Trajectory (CoFi)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Estimated Trajectory (PF)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Particles (PF)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Particles (CoFi)&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">]</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">)</span>
<span class="c1"># map.save_to_html(file_name=&quot;visualize_results.html&quot;)</span>
<span class="nb">map</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<p>You can now invoke <code class="docutils literal notranslate"><span class="pre">show-html.py</span></code> to serve the HTML file.</p>
</section>
<section id="Visualize-the-results-with-matplotlib">
<h3>Visualize the results with matplotlib<a class="headerlink" href="#Visualize-the-results-with-matplotlib" title="Link to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">vessel_type</span> <span class="ow">in</span> <span class="n">interpolators</span><span class="p">:</span>
    <span class="n">df_</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;VesselTypeName&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">vessel_type</span><span class="p">]</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">df_</span><span class="p">[[</span><span class="s2">&quot;East&quot;</span><span class="p">,</span> <span class="s2">&quot;North&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">interpolators</span><span class="p">[</span><span class="n">vessel_type</span><span class="p">](</span><span class="n">points</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
        <span class="n">res_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;Vessel Type&quot;</span><span class="p">:</span> <span class="n">vessel_type</span><span class="p">,</span>
                <span class="s2">&quot;Constitutional&quot;</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
            <span class="p">}</span>
        <span class="p">)</span>

<span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res_</span><span class="p">)</span>
<span class="k">del</span> <span class="n">res_</span>
<span class="n">res_df</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Vessel Type</th>
      <th>Constitutional</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Cargo</td>
      <td>0.855000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Cargo</td>
      <td>0.855000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Cargo</td>
      <td>0.855000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Cargo</td>
      <td>0.855000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Cargo</td>
      <td>0.855000</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>43583</th>
      <td>Towing</td>
      <td>0.063174</td>
    </tr>
    <tr>
      <th>43584</th>
      <td>Towing</td>
      <td>0.060033</td>
    </tr>
    <tr>
      <th>43585</th>
      <td>Towing</td>
      <td>0.059731</td>
    </tr>
    <tr>
      <th>43586</th>
      <td>Towing</td>
      <td>0.060372</td>
    </tr>
    <tr>
      <th>43587</th>
      <td>Towing</td>
      <td>0.061517</td>
    </tr>
  </tbody>
</table>
<p>43588 rows × 2 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">res_df</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s2">&quot;Vessel Type&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Search and rescue vessels&quot;</span><span class="p">:</span> <span class="s2">&quot;SAR&quot;</span><span class="p">}}),</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;Vessel Type&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Constitutional&quot;</span><span class="p">,</span>
    <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;Vessel Type&quot;</span><span class="p">,</span>
    <span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Cargo&quot;</span><span class="p">,</span> <span class="s2">&quot;Towing&quot;</span><span class="p">,</span> <span class="s2">&quot;SAR&quot;</span><span class="p">],</span>
    <span class="n">hue_order</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Cargo&quot;</span><span class="p">,</span> <span class="s2">&quot;Towing&quot;</span><span class="p">,</span> <span class="s2">&quot;SAR&quot;</span><span class="p">],</span>
    <span class="n">palette</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;tab10&quot;</span><span class="p">)[:</span><span class="mi">3</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Expected $P(C_t | \mathbf</span><span class="si">{x}</span><span class="s2">_t, \mathbf</span><span class="si">{z}</span><span class="s2">_t)$&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plot_put</span> <span class="o">=</span> <span class="n">output_folder</span> <span class="o">/</span> <span class="s2">&quot;plots&quot;</span>
<span class="n">plot_put</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_put</span> <span class="o">/</span> <span class="s2">&quot;ais-constitution.pdf&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
<span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_91_0.png" src="../_images/notebooks_cofi-maritime_91_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_results_export</span> <span class="o">=</span> <span class="n">df_results</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span>
    <span class="p">[</span><span class="s2">&quot;mmsi&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;tau&quot;</span><span class="p">,</span> <span class="s2">&quot;seed&quot;</span><span class="p">,</span> <span class="s2">&quot;pos_error_mean&quot;</span><span class="p">,</span> <span class="s2">&quot;all_error_mean&quot;</span><span class="p">]</span>
<span class="p">]</span>
<span class="n">df_results_export</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_folder</span> <span class="o">/</span> <span class="s2">&quot;res-all-taus.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">df_renamed</span> <span class="o">=</span> <span class="n">df_results_export</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Vessel Type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tau&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$\tau$&quot;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="n">df_</span> <span class="o">=</span> <span class="n">df_renamed</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\tau$&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;pos_error_mean&quot;</span><span class="p">,</span>
    <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;Vessel Type&quot;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">df_</span><span class="p">[</span><span class="n">df_</span><span class="p">[</span><span class="sa">r</span><span class="s2">&quot;$\tau$&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])],</span>
    <span class="n">hue_order</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Cargo&quot;</span><span class="p">,</span> <span class="s2">&quot;Towing&quot;</span><span class="p">,</span> <span class="s2">&quot;Search and rescue vessels&quot;</span><span class="p">],</span>
<span class="p">)</span>

<span class="c1"># move the legend outside</span>
<span class="n">sns</span><span class="o">.</span><span class="n">move_legend</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">(),</span> <span class="s2">&quot;upper left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_put</span> <span class="o">/</span> <span class="s2">&quot;relative_position_error.pdf&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
<span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_92_0.png" src="../_images/notebooks_cofi-maritime_92_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_renamed</span><span class="p">[</span><span class="s2">&quot;Vessel Type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Vessel Type
Towing                       880
Cargo                        165
Search and rescue vessels     55
Name: count, dtype: int64
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">type_wise_data</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="n">df_renamed</span><span class="p">[</span><span class="s2">&quot;Vessel Type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="n">type_data</span> <span class="o">=</span> <span class="n">df_renamed</span><span class="p">[</span><span class="n">df_renamed</span><span class="p">[</span><span class="s2">&quot;Vessel Type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">type</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">type_data</span><span class="p">[</span><span class="s2">&quot;Relative Position Error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">type_data</span><span class="p">[</span><span class="s2">&quot;pos_error_mean&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">type_data</span><span class="p">[</span><span class="s2">&quot;pos_error_mean&quot;</span><span class="p">][</span><span class="n">type_data</span><span class="p">[</span><span class="sa">r</span><span class="s2">&quot;$\tau$&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">type_wise_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">type_data</span><span class="p">)</span>

<span class="n">normalized_data_per_type</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">type_wise_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">aggregated_data</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">mmsi</span> <span class="ow">in</span> <span class="n">df_renamed</span><span class="p">[</span><span class="s2">&quot;mmsi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="n">mmsi_data</span> <span class="o">=</span> <span class="n">df_renamed</span><span class="p">[</span><span class="n">df_renamed</span><span class="p">[</span><span class="s2">&quot;mmsi&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">mmsi</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">mmsi_data</span><span class="p">[</span><span class="sa">r</span><span class="s2">&quot;Best $\tau$&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mmsi_data</span><span class="p">[</span>
        <span class="n">mmsi_data</span><span class="p">[</span><span class="s2">&quot;pos_error_mean&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">mmsi_data</span><span class="p">[</span><span class="s2">&quot;pos_error_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="p">][</span><span class="sa">r</span><span class="s2">&quot;$\tau$&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mmsi_data</span><span class="p">[</span><span class="s2">&quot;Relative Position Error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">mmsi_data</span><span class="p">[</span><span class="s2">&quot;pos_error_mean&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">mmsi_data</span><span class="p">[</span><span class="s2">&quot;pos_error_mean&quot;</span><span class="p">][</span><span class="n">mmsi_data</span><span class="p">[</span><span class="sa">r</span><span class="s2">&quot;$\tau$&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">aggregated_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mmsi_data</span><span class="p">)</span>

<span class="n">normalized_to_pf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">aggregated_data</span><span class="p">)</span>
<span class="n">normalized_to_pf</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mmsi</th>
      <th>Vessel Type</th>
      <th>$\tau$</th>
      <th>seed</th>
      <th>pos_error_mean</th>
      <th>all_error_mean</th>
      <th>Best $\tau$</th>
      <th>Relative Position Error</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>368111580</td>
      <td>Search and rescue vessels</td>
      <td>0.0</td>
      <td>2023</td>
      <td>7.756023e+07</td>
      <td>7.756023e+07</td>
      <td>0.1</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>368111580</td>
      <td>Search and rescue vessels</td>
      <td>0.1</td>
      <td>2023</td>
      <td>6.560513e+06</td>
      <td>6.560513e+06</td>
      <td>0.1</td>
      <td>0.084586</td>
    </tr>
    <tr>
      <th>2</th>
      <td>368111580</td>
      <td>Search and rescue vessels</td>
      <td>0.2</td>
      <td>2023</td>
      <td>7.831044e+06</td>
      <td>7.831044e+06</td>
      <td>0.1</td>
      <td>0.100967</td>
    </tr>
    <tr>
      <th>3</th>
      <td>368111580</td>
      <td>Search and rescue vessels</td>
      <td>0.3</td>
      <td>2023</td>
      <td>2.182914e+07</td>
      <td>2.182914e+07</td>
      <td>0.1</td>
      <td>0.281448</td>
    </tr>
    <tr>
      <th>4</th>
      <td>368111580</td>
      <td>Search and rescue vessels</td>
      <td>0.4</td>
      <td>2023</td>
      <td>1.550461e+07</td>
      <td>1.550461e+07</td>
      <td>0.1</td>
      <td>0.199904</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1095</th>
      <td>565565000</td>
      <td>Cargo</td>
      <td>0.6</td>
      <td>2023</td>
      <td>8.521922e+01</td>
      <td>8.612133e+01</td>
      <td>0.0</td>
      <td>1.538771</td>
    </tr>
    <tr>
      <th>1096</th>
      <td>565565000</td>
      <td>Cargo</td>
      <td>0.7</td>
      <td>2023</td>
      <td>8.965442e+01</td>
      <td>9.053325e+01</td>
      <td>0.0</td>
      <td>1.618856</td>
    </tr>
    <tr>
      <th>1097</th>
      <td>565565000</td>
      <td>Cargo</td>
      <td>0.8</td>
      <td>2023</td>
      <td>8.525719e+01</td>
      <td>8.614562e+01</td>
      <td>0.0</td>
      <td>1.539457</td>
    </tr>
    <tr>
      <th>1098</th>
      <td>565565000</td>
      <td>Cargo</td>
      <td>0.9</td>
      <td>2023</td>
      <td>8.836533e+01</td>
      <td>8.912667e+01</td>
      <td>0.0</td>
      <td>1.595579</td>
    </tr>
    <tr>
      <th>1099</th>
      <td>565565000</td>
      <td>Cargo</td>
      <td>1.0</td>
      <td>2023</td>
      <td>8.569716e+01</td>
      <td>8.664089e+01</td>
      <td>0.0</td>
      <td>1.547401</td>
    </tr>
  </tbody>
</table>
<p>1100 rows × 8 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">historgram</span> <span class="o">=</span> <span class="n">normalized_to_pf</span><span class="p">[</span><span class="sa">r</span><span class="s2">&quot;Best $\tau$&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">historgram</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best $\tau$
0.0    23.0
0.1     9.0
0.2    11.0
0.3     7.0
0.4     7.0
0.5     8.0
0.6     8.0
0.7     8.0
0.8     5.0
0.9     7.0
1.0     7.0
Name: proportion, dtype: float64
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[76]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plt.title(&quot;Distribution of optimal taus&quot;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
    <span class="n">historgram</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="n">historgram</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;tab10&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;tab10&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Optimal $\tau$&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="kn">import</span> <span class="n">PercentFormatter</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Fraction of Vessels&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">Patch</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
    <span class="n">handles</span><span class="o">=</span><span class="p">[</span>
        <span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;tab10&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Particle Filter&quot;</span><span class="p">),</span>
        <span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;tab10&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;CoFi&quot;</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.45</span><span class="p">,</span> <span class="mf">1.075</span><span class="p">),</span>
    <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.06</span><span class="p">,</span> <span class="mf">1.06</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_put</span> <span class="o">/</span> <span class="s2">&quot;optimal-taus.pdf&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>

<span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_97_0.png" src="../_images/notebooks_cofi-maritime_97_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[80]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_</span> <span class="o">=</span> <span class="n">normalized_to_pf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_</span> <span class="o">=</span> <span class="n">df_</span><span class="p">[(</span><span class="n">df_</span><span class="p">[</span><span class="sa">r</span><span class="s2">&quot;Best $\tau$&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">df_</span><span class="p">[</span><span class="sa">r</span><span class="s2">&quot;$\tau$&quot;</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">df_</span><span class="p">[</span><span class="sa">r</span><span class="s2">&quot;$\tau$&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)]</span>

<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span>
    <span class="n">df_</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\tau$&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Relative Position Error&quot;</span><span class="p">,</span>
    <span class="n">err_style</span><span class="o">=</span><span class="s2">&quot;bars&quot;</span><span class="p">,</span>
    <span class="n">errorbar</span><span class="o">=</span><span class="s2">&quot;ci&quot;</span><span class="p">,</span>
    <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;tab10&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;tab10&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.02</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.005</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
    <span class="n">handles</span><span class="o">=</span><span class="p">[</span>
        <span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;tab10&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Particle Filter&quot;</span><span class="p">),</span>
        <span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;tab10&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;CoFi&quot;</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
    <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Optimal $\tau$&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Relative Error&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_put</span> <span class="o">/</span> <span class="s2">&quot;relative_position_error_best_tau.pdf&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
<span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_98_0.png" src="../_images/notebooks_cofi-maritime_98_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\tau$&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Relative Position Error&quot;</span><span class="p">,</span>
    <span class="c1"># hue=&quot;Vessel Type&quot;,</span>
    <span class="n">hue</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Best $\tau$&quot;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">normalized_to_pf</span><span class="p">,</span>
    <span class="n">errorbar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Particle Filter&quot;</span><span class="p">)</span>
<span class="c1"># plt.legend(title=&quot;Vessel Type&quot;, loc=&quot;upper left&quot;, bbox_to_anchor=(1, 1))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
<span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[85]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">mmis</span> <span class="ow">in</span> <span class="n">df_results</span><span class="p">[</span><span class="s2">&quot;mmsi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="n">df_</span> <span class="o">=</span> <span class="n">df_results</span><span class="p">[</span><span class="n">df_results</span><span class="p">[</span><span class="s2">&quot;mmsi&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">mmis</span><span class="p">]</span>
    <span class="c1"># sort by tau</span>
    <span class="n">df_</span> <span class="o">=</span> <span class="n">df_</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;pos_error_mean&quot;</span><span class="p">)</span>
    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">df_</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">df_</span><span class="p">[</span><span class="s2">&quot;tau&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Vessel Type&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\tau$&quot;</span><span class="p">])</span>
<span class="c1"># Rname Search and rescue vessels to SAR</span>
<span class="n">res</span><span class="p">[</span><span class="s2">&quot;Vessel Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;Vessel Type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Search and rescue vessels&quot;</span><span class="p">,</span> <span class="s2">&quot;SAR&quot;</span><span class="p">)</span>
<span class="n">res</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[85]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Vessel Type</th>
      <th>$\tau$</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>SAR</td>
      <td>0.1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Towing</td>
      <td>0.6</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Towing</td>
      <td>0.4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Towing</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Towing</td>
      <td>0.7</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>95</th>
      <td>Cargo</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>96</th>
      <td>Cargo</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>97</th>
      <td>SAR</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>98</th>
      <td>Cargo</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>99</th>
      <td>Cargo</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>100 rows × 2 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[86]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r_</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># r_[&quot;Vessel Type&quot;] = &quot;All&quot;</span>
<span class="c1"># res_ = pd.concat([res, r_], axis=0)</span>
<span class="c1"># res_.sort_values(&quot;Vessel Type&quot;, inplace=True)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span>
    <span class="n">r_</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\tau$&quot;</span><span class="p">,</span>
    <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;Vessel Type&quot;</span><span class="p">,</span>
    <span class="n">multiple</span><span class="o">=</span><span class="s2">&quot;stack&quot;</span><span class="p">,</span>
    <span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">stat</span><span class="o">=</span><span class="s2">&quot;percent&quot;</span><span class="p">,</span>
    <span class="n">shrink</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
    <span class="c1"># palette=&quot;colorblind&quot;,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span><span class="si">}</span><span class="s2">%&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">()[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>

<span class="c1"># Fix the placmenet of the x-axis</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_folder</span> <span class="o">/</span> <span class="s2">&quot;tau-distribution.pdf&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>

<span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cofi-maritime_101_0.png" src="../_images/notebooks_cofi-maritime_101_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Simon Kohaut.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>